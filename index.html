<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบติดตามงานค้าง</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">
    <style>
        body {
            font-family: 'Sarabun', sans-serif;
        }

        /* Glassmorphism */
        .glass {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.4);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.07);
        }

        .scroll-mask {
            mask-image: linear-gradient(to right, transparent, black 20px, black 90%, transparent);
            -webkit-mask-image: linear-gradient(to right, transparent, black 20px, black calc(100% - 20px), transparent);
        }

        /* Animations */
        @keyframes popIn {
            0% {
                transform: scale(0.9);
                opacity: 0;
            }

            100% {
                transform: scale(1);
                opacity: 1;
            }
        }

        .animate-pop {
            animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
        }

        @keyframes slideUp {
            from {
                transform: translateY(20px);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .animate-entry {
            animation: slideUp 0.4s ease-out forwards;
            opacity: 0;
        }

        /* Custom Scrollbar */
        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }

        .scrollbar-hide {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        /* Button Press Effect */
        .btn-press:active {
            transform: scale(0.95);
        }

        /* Toast Notification */
        #toast-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 50;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .toast {
            background: white;
            border-left: 4px solid #14b8a6;
            padding: 16px 24px;
            border-radius: 12px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            gap: 12px;
            animation: slideInRight 0.3s ease-out forwards;
            min-width: 300px;
        }

        .toast.error {
            border-left-color: #f43f5e;
        }

        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes fadeOut {
            to {
                opacity: 0;
                transform: translateY(10px);
            }
        }

        /* Accordion Transition */
        .accordion-content {
            transition: max-height 0.3s ease-in-out, opacity 0.3s ease-in-out;
            max-height: 0;
            opacity: 0;
            overflow: hidden;
        }

        .accordion-content.expanded {
            max-height: 1000px;
            opacity: 1;
        }

        .chevron {
            transition: transform 0.3s ease;
        }

        .chevron.rotated {
            transform: rotate(180deg);
        }

        /* Print Styles */
        @media print {
            .no-print {
                display: none !important;
            }

            body {
                background: white;
            }

            .glass {
                box-shadow: none;
                border: none;
                background: white;
            }
        }
    </style>
</head>

<body class="bg-slate-50 min-h-screen text-slate-800 selection:bg-teal-100 selection:text-teal-700">

    <!-- Toast Container -->
    <div id="toast-container"></div>

    <!-- Custom Confirm Modal -->
    <div id="confirmModal" class="fixed inset-0 z-[60] hidden items-center justify-center p-4">
        <div class="absolute inset-0 bg-slate-900/40 backdrop-blur-sm transition-opacity opacity-0"
            id="confirmBackdrop"></div>
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm p-6 transform scale-95 opacity-0 transition-all relative z-10"
            id="confirmContent">
            <div class="mb-4">
                <div
                    class="w-12 h-12 bg-rose-100 text-rose-500 rounded-full flex items-center justify-center mb-3 mx-auto">
                    <i data-lucide="alert-triangle" class="w-6 h-6"></i>
                </div>
                <h3 class="text-lg font-bold text-center text-slate-800 mb-1" id="confirmTitle">ยืนยันการลบ?</h3>
                <p class="text-sm text-center text-slate-500" id="confirmMessage">ข้อมูลจะหายไปและกู้คืนไม่ได้</p>
            </div>
            <div class="flex gap-3">
                <button id="confirmCancelBtn"
                    class="flex-1 py-2.5 rounded-xl border border-slate-200 text-slate-600 font-bold text-sm hover:bg-slate-50 btn-press">ยกเลิก</button>
                <button id="confirmOkBtn"
                    class="flex-1 py-2.5 rounded-xl bg-rose-500 text-white font-bold text-sm hover:bg-rose-600 shadow-lg shadow-rose-200 btn-press">ยืนยันลบ</button>
            </div>
        </div>
    </div>

    <div class="max-w-6xl mx-auto p-4 md:p-8 pb-32">
        <!-- Header -->
        <div
            class="glass sticky top-4 z-40 flex flex-col md:flex-row justify-between items-center mb-6 gap-4 p-4 md:p-6 rounded-2xl shadow-sm transition-all duration-300">
            <div class="flex items-center gap-4">
                <div
                    class="bg-gradient-to-br from-teal-400 to-teal-600 p-3 rounded-xl text-white shadow-lg shadow-teal-200 animate-pop">
                    <i data-lucide="clipboard-list" class="w-7 h-7"></i>
                </div>
                <div>
                    <h1 class="text-2xl font-bold text-slate-800 tracking-tight">ระบบติดตามงานค้าง</h1>
                    <p class="text-slate-500 text-sm font-medium">ภาคเรียนที่ 2/2568</p>
                </div>
            </div>
            <div class="flex items-center gap-3 no-print">
                <button onclick="openManageModal()"
                    class="btn-press flex items-center gap-2 bg-slate-100/80 text-slate-600 px-4 py-2 rounded-xl hover:bg-slate-200 transition-colors text-sm font-bold backdrop-blur-sm">
                    <i data-lucide="settings" class="w-4 h-4"></i>
                    จัดการวิชา/งาน
                </button>
                <div class="hidden md:block text-right border-l pl-4 border-slate-200">
                    <div class="text-[10px] font-bold text-slate-400 uppercase tracking-wider">Today</div>
                    <div id="printDate" class="text-teal-600 font-bold text-sm"></div>
                </div>
            </div>
        </div>

        <!-- Subject Tabs -->
        <div class="relative mx-[-16px] px-[16px] md:mx-0 md:px-0">
            <div class="flex overflow-x-auto gap-3 mb-6 scrollbar-hide no-print py-2 px-1 scroll-mask" id="subjectTabs">
                <!-- Tabs injected here -->
            </div>
        </div>

        <!-- Add Student Form -->
        <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100 mb-6 no-print animate-entry"
            style="animation-delay: 0.1s;">
            <form id="addStudentForm" class="flex flex-col md:flex-row gap-4 items-end">
                <div class="flex-1 w-full">
                    <label for="studentNameInput"
                        class="block text-sm font-bold text-slate-700 mb-2 flex items-center gap-2">
                        <i data-lucide="user-plus" class="w-4 h-4 text-teal-500"></i>
                        เพิ่มชื่อบุคคล
                    </label>
                    <input type="text" id="studentNameInput"
                        class="w-full p-3 border border-slate-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-teal-500 focus:border-transparent transition-all bg-slate-50 hover:bg-white"
                        placeholder="พิมพ์ชื่อ-นามสกุล แล้วกด Enter...">
                </div>
                <button type="submit"
                    class="btn-press bg-teal-600 text-white px-6 py-3 rounded-xl hover:bg-teal-700 transition-colors font-bold shadow-lg shadow-teal-200 flex items-center gap-2 w-full md:w-auto justify-center">
                    <i data-lucide="save" class="w-4 h-4"></i>
                    บันทึก
                </button>
            </form>
        </div>

        <!-- Search & Filter -->
        <div class="mb-6 flex flex-col md:flex-row gap-4 items-center justify-between animate-entry"
            style="animation-delay: 0.15s;">
            <div class="relative w-full md:w-96">
                <i data-lucide="search" class="absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-slate-400"></i>
                <input type="text" id="searchInput" oninput="renderApp()"
                    class="w-full pl-10 pr-4 py-3 rounded-xl border border-slate-200 focus:outline-none focus:ring-2 focus:ring-teal-500 bg-white shadow-sm"
                    placeholder="ค้นหาชื่อนักเรียน..." aria-label="ค้นหาชื่อนักเรียน">
            </div>
            <div class="flex gap-2 w-full md:w-auto">
                <select id="sortSelect" onchange="renderApp()"
                    class="px-4 py-3 rounded-xl border border-slate-200 focus:outline-none focus:ring-2 focus:ring-teal-500 bg-white shadow-sm text-sm font-bold text-slate-600 cursor-pointer">
                    <option value="default">เรียงตามเลขที่ (เดิม)</option>
                    <option value="most_missing">งานค้างมากสุด</option>
                    <option value="least_missing">งานค้างน้อยสุด</option>
                </select>
            </div>
            <div class="flex gap-2 w-full md:w-auto">
                <div
                    class="bg-white px-4 py-2 rounded-xl border border-slate-200 shadow-sm flex items-center gap-2 text-sm font-bold text-slate-600">
                    <span class="w-2 h-2 rounded-full bg-teal-500"></span>
                    ส่งครบ: <span id="countComplete" class="text-teal-600">0</span>
                </div>
                <div
                    class="bg-white px-4 py-2 rounded-xl border border-slate-200 shadow-sm flex items-center gap-2 text-sm font-bold text-slate-600">
                    <span class="w-2 h-2 rounded-full bg-rose-500"></span>
                    ค้างงาน: <span id="countIncomplete" class="text-rose-600">0</span>
                </div>
            </div>
        </div>

        <!-- Main Content Area -->
        <div class="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden min-h-[300px] animate-entry"
            style="animation-delay: 0.2s;">
            <!-- Desktop Table View -->
            <div class="hidden md:block overflow-x-auto">
                <table class="w-full text-left border-collapse">
                    <thead
                        class="bg-slate-50/50 text-slate-600 text-sm uppercase tracking-wider border-b border-slate-100">
                        <tr id="tableHeaderRow">
                            <!-- Headers injected here -->
                        </tr>
                    </thead>
                    <tbody id="studentTableBody">
                        <!-- Rows injected here -->
                    </tbody>
                </table>
            </div>

            <!-- Mobile Card View -->
            <div class="md:hidden p-4 space-y-3" id="mobileStudentList">
                <!-- Cards injected here -->
            </div>
        </div>

        <!-- Footer -->
        <div class="mt-8 text-center text-slate-400 text-xs pb-20 md:pb-8">
            <p class="opacity-50">ระบบติดตามงานค้าง v2.2 (Expandable Cards)</p>
        </div>

        <!-- Floating Action Button for Reset -->
        <div class="fixed bottom-6 right-6 no-print z-40">
            <button onclick="confirmReset()"
                class="btn-press bg-slate-800 text-white p-4 rounded-full shadow-2xl hover:bg-slate-700 transition-all shadow-slate-400/50"
                title="ล้างข้อมูลทั้งหมด">
                <i data-lucide="rotate-ccw" class="w-6 h-6"></i>
            </button>
        </div>
    </div>

    <!-- Management Modal -->
    <div id="manageModal" class="fixed inset-0 z-50 hidden items-center justify-center p-4">
        <div class="absolute inset-0 bg-slate-900/30 backdrop-blur-sm transition-opacity opacity-0" id="manageBackdrop"
            onclick="closeManageModal()"></div>
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-2xl max-h-[85vh] flex flex-col transform scale-95 opacity-0 transition-all relative z-10"
            id="manageContent">
            <div class="p-6 border-b border-slate-100 flex justify-between items-center bg-white rounded-t-2xl">
                <h2 class="text-xl font-bold text-slate-800 flex items-center gap-2">
                    <div class="p-2 bg-teal-50 rounded-lg text-teal-600">
                        <i data-lucide="settings" class="w-5 h-5"></i>
                    </div>
                    จัดการวิชาและงาน
                </h2>
                <div class="flex gap-2">
                    <button onclick="exportData()"
                        class="btn-press text-slate-500 hover:text-teal-600 p-2 hover:bg-teal-50 rounded-lg transition-colors"
                        title="Export Data">
                        <i data-lucide="download" class="w-5 h-5"></i>
                    </button>
                    <label
                        class="btn-press text-slate-500 hover:text-teal-600 p-2 hover:bg-teal-50 rounded-lg transition-colors cursor-pointer"
                        title="Import Data">
                        <i data-lucide="upload" class="w-5 h-5"></i>
                        <input type="file" id="importFile" class="hidden" accept=".json" onchange="importData(this)">
                    </label>
                    <div class="w-px h-6 bg-slate-200 mx-1"></div>
                    <button onclick="closeManageModal()"
                        class="btn-press text-slate-400 hover:text-rose-500 p-2 hover:bg-rose-50 rounded-full transition-colors">
                        <i data-lucide="x" class="w-6 h-6"></i>
                    </button>
                </div>
            </div>

            <div class="p-6 overflow-y-auto flex-1 space-y-6 bg-slate-50/50">
                <!-- Add Subject Section -->
                <div class="bg-white p-5 rounded-xl border border-slate-200 shadow-sm">
                    <h3 class="font-bold text-slate-700 mb-3 text-sm flex items-center gap-2">
                        <i data-lucide="folder-plus" class="w-4 h-4 text-teal-500"></i>
                        เพิ่มวิชาใหม่
                    </h3>
                    <form onsubmit="handleAddSubject(event)" class="flex gap-3">
                        <input type="text" id="newSubjectInput" placeholder="ชื่อวิชา (เช่น Media, Graphic)"
                            class="flex-1 p-2.5 border border-slate-200 rounded-xl text-sm focus:outline-none focus:ring-2 focus:ring-teal-500 bg-slate-50">
                        <button type="submit"
                            class="btn-press bg-teal-600 text-white px-5 py-2.5 rounded-xl text-sm font-bold hover:bg-teal-700 shadow-lg shadow-teal-100">เพิ่ม</button>
                    </form>
                </div>

                <!-- Subjects List -->
                <div id="manageSubjectsList" class="space-y-4">
                    <!-- Subject Items injected here -->
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- Data Structure ---
        const STORAGE_KEY = 'student_tracker_data_v2';

        // Default Data
        const defaultData = {
            currentSubjectId: 'sub_1',
            subjects: [
                {
                    id: 'sub_1',
                    name: 'Media (Video)',
                    assignments: [
                        { id: 'w1', title: 'งานที่ 1', desc: 'สรุปหลักการ → พร้อม Pitch Deck' },
                        { id: 'w2', title: 'งานที่ 2', desc: 'ข่าวทั่วไป → พร้อม Pitch Deck' },
                        { id: 'w3', title: 'งานที่ 3', desc: 'สรุปทฤษฎี → พร้อม Pitch Deck' },
                        { id: 'w4', title: 'งานที่ 4', desc: 'วาด 9 ช่อง / แบบตัวอย่างนักเรียน' },
                        { id: 'w5', title: 'งานที่ 5', desc: 'สไลด์รีวิวหนังสั้น → พร้อม Pitch Deck' },
                        { id: 'w6', title: 'งานที่ 6', desc: 'AI Traffic Brain → พร้อม Pitch Deck' },
                        { id: 'w7', title: 'งานที่ 7', desc: 'มุมวัฒนธรรม → พร้อม Pitch Deck' }
                    ]
                },
                {
                    id: 'sub_2',
                    name: 'Graphic (Model)',
                    assignments: [
                        { id: 'g1', title: 'งานที่ 1', desc: 'ออกแบบ Character' },
                        { id: 'g2', title: 'งานที่ 2', desc: 'ปั้นโมเดล 3D' }
                    ]
                }
            ],
            students: [
                { id: 1, name: 'ตัวอย่าง: นาย ก.', missing: ['w1', 'g1'] },
                { id: 2, name: 'ตัวอย่าง: นาย ข.', missing: ['w4'] }
            ]
        };

        let appData = JSON.parse(JSON.stringify(defaultData));

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            loadData();
            renderApp();
            const dateEl = document.getElementById('printDate');
            if (dateEl) dateEl.innerText = new Date().toLocaleDateString('th-TH', { weekday: 'short', day: 'numeric', month: 'short', year: '2-digit' });

            // Add Student Form Listener
            const addStudentForm = document.getElementById('addStudentForm');
            if (addStudentForm) {
                addStudentForm.addEventListener('submit', (e) => {
                    e.preventDefault();
                    const input = document.getElementById('studentNameInput');
                    const name = input.value.trim();
                    if (name) {
                        const newId = appData.students.length > 0 ? Math.max(...appData.students.map(s => s.id)) + 1 : 1;
                        // Default to all incomplete (missing all assignments)
                        const allAssignmentIds = appData.subjects.flatMap(s => s.assignments.map(a => a.id));
                        appData.students.push({ id: newId, name: name, missing: allAssignmentIds });

                        saveData();
                        renderApp();
                        input.value = '';
                        showToast(`เพิ่ม "${name}" เรียบร้อย`);

                        // Scroll to bottom
                        setTimeout(() => {
                            window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
                        }, 100);
                    }
                });
            }
        });

        // --- Core Functions ---
        function loadData() {
            const saved = localStorage.getItem(STORAGE_KEY);
            if (saved) {
                try {
                    const parsed = JSON.parse(saved);
                    if (!parsed.subjects || !Array.isArray(parsed.subjects) || !parsed.students || !Array.isArray(parsed.students)) {
                        throw new Error('Invalid data structure');
                    }
                    appData = parsed;
                    if (!appData.subjects.find(s => s.id === appData.currentSubjectId)) {
                        appData.currentSubjectId = appData.subjects[0]?.id || '';
                    }
                } catch (e) {
                    console.error('Error loading data', e);
                    localStorage.removeItem(STORAGE_KEY);
                    appData = JSON.parse(JSON.stringify(defaultData));
                }
            }
        }

        function saveData() {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(appData));
        }

        function confirmReset() {
            showConfirmModal(
                'ล้างข้อมูลทั้งหมด?',
                'ข้อมูลนักเรียนและงานทั้งหมดจะหายไป เริ่มต้นใหม่',
                () => {
                    localStorage.removeItem(STORAGE_KEY);
                    location.reload();
                }
            );
        }

        function markAllComplete(studentId) {
            const student = appData.students.find(s => s.id === studentId);
            const currentSubject = appData.subjects.find(s => s.id === appData.currentSubjectId);

            if (student && currentSubject) {
                const assignmentIds = currentSubject.assignments.map(a => a.id);
                student.missing = student.missing.filter(m => !assignmentIds.includes(m));

                saveData();
                renderApp();
                showToast(`เช็คงานครบให้ "${student.name}" แล้ว`);
            }
        }

        function exportData() {
            const dataStr = JSON.stringify(appData, null, 2);
            const blob = new Blob([dataStr], { type: "application/json" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `student_tracker_backup_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            showToast('ดาวน์โหลดไฟล์ Backup แล้ว');
        }

        function importData(input) {
            const file = input.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function (e) {
                try {
                    const parsed = JSON.parse(e.target.result);
                    if (parsed.subjects && parsed.students) {
                        appData = parsed;
                        saveData();
                        renderApp();
                        showToast('นำเข้าข้อมูลสำเร็จ');
                        closeManageModal();
                    } else {
                        throw new Error('Invalid format');
                    }
                } catch (err) {
                    showToast('ไฟล์ไม่ถูกต้อง', 'error');
                    console.error(err);
                }
                input.value = ''; // Reset input
            };
            reader.readAsText(file);
        }

        function renderApp() {
            try {
                renderTabs();
                renderTable();
                renderMobileCards();
                renderManageModal();
                lucide.createIcons();
            } catch (e) {
                console.error("Render Error:", e);
            }
        }

        // --- Render Functions ---
        function renderTabs() {
            const container = document.getElementById('subjectTabs');
            container.innerHTML = appData.subjects.map(sub => {
                const isActive = sub.id === appData.currentSubjectId;
                return `
                    <button onclick="switchSubject('${sub.id}')" 
                        class="whitespace-nowrap px-5 py-2.5 rounded-xl text-sm font-bold transition-all ${isActive
                        ? 'bg-teal-600 text-white shadow-lg shadow-teal-200 scale-105'
                        : 'bg-white text-slate-600 hover:bg-slate-50 border border-slate-200'
                    }">
                        ${sub.name}
                    </button>
                `;
            }).join('');
        }

        function renderTable() {
            const tbody = document.getElementById('studentTableBody');
            const headerRow = document.getElementById('tableHeaderRow');
            const currentSubject = appData.subjects.find(s => s.id === appData.currentSubjectId);

            if (!currentSubject) return;

            // Render Headers
            headerRow.innerHTML = `
                <th class="p-4 rounded-tl-xl bg-slate-50 border-b border-slate-100 w-16 text-center">#</th>
                <th class="p-4 bg-slate-50 border-b border-slate-100 text-left min-w-[200px]">ชื่อ - นามสกุล</th>
                ${currentSubject.assignments.map(a => `
                    <th class="p-2 bg-slate-50 border-b border-slate-100 text-center w-24 group relative">
                        <div class="flex flex-col items-center">
                            <span class="font-bold text-slate-700">${a.title}</span>
                            <span class="text-[10px] font-normal text-slate-400 max-w-[80px] truncate">${a.desc}</span>
                        </div>
                        <!-- Tooltip -->
                        <div class="absolute bottom-full left-1/2 -translate-x-1/2 mb-2 px-2 py-1 bg-slate-800 text-white text-xs rounded opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none whitespace-nowrap z-10">
                            ${a.desc}
                        </div>
                    </th>
                `).join('')}
                <th class="p-4 rounded-tr-xl bg-slate-50 border-b border-slate-100 w-32 text-left">สถานะ</th>
                <th class="p-4 bg-slate-50 border-b border-slate-100 w-16"></th>
            `;

            // Render Rows
            const searchTerm = document.getElementById('searchInput')?.value.trim().toLowerCase() || '';
            const sortOption = document.getElementById('sortSelect')?.value || 'default';

            let filteredStudents = appData.students.filter(s => s.name.toLowerCase().includes(searchTerm));

            // Sorting Logic
            if (sortOption === 'most_missing') {
                filteredStudents.sort((a, b) => {
                    const missingA = a.missing.filter(m => currentSubject.assignments.some(assign => assign.id === m)).length;
                    const missingB = b.missing.filter(m => currentSubject.assignments.some(assign => assign.id === m)).length;
                    return missingB - missingA;
                });
            } else if (sortOption === 'least_missing') {
                filteredStudents.sort((a, b) => {
                    const missingA = a.missing.filter(m => currentSubject.assignments.some(assign => assign.id === m)).length;
                    const missingB = b.missing.filter(m => currentSubject.assignments.some(assign => assign.id === m)).length;
                    return missingA - missingB;
                });
            } else {
                // Default: Sort by ID
                filteredStudents.sort((a, b) => a.id - b.id);
            }

            // Update Counts
            const completeCount = filteredStudents.filter(s => s.missing.filter(m => currentSubject.assignments.some(a => a.id === m)).length === 0).length;
            document.getElementById('countComplete').innerText = completeCount;
            document.getElementById('countIncomplete').innerText = filteredStudents.length - completeCount;

            if (filteredStudents.length === 0) {
                tbody.innerHTML = `<tr><td colspan="${currentSubject.assignments.length + 4}" class="p-12 text-center text-slate-400 italic">ไม่พบรายชื่อนักเรียน</td></tr>`;
                return;
            }

            tbody.innerHTML = filteredStudents.map((s, index) => {
                const totalAssignments = currentSubject.assignments.length;
                const missingCount = s.missing.filter(m => currentSubject.assignments.some(a => a.id === m)).length;
                const completedCount = totalAssignments - missingCount;
                const progressPercent = totalAssignments === 0 ? 0 : (completedCount / totalAssignments) * 100;
                const isComplete = missingCount === 0;

                return `
                    <tr class="border-b border-slate-50 hover:bg-slate-50/50 transition-colors group">
                        <td class="p-4 text-center text-slate-400 font-mono text-xs">${index + 1}</td>
                        <td class="p-4">
                            <div class="font-bold text-slate-700">${s.name}</div>
                            <!-- Progress Bar -->
                            <div class="w-full bg-slate-100 rounded-full h-1.5 mt-2 overflow-hidden">
                                <div class="bg-teal-500 h-1.5 rounded-full transition-all duration-500" style="width: ${progressPercent}%"></div>
                            </div>
                        </td>
                        ${currentSubject.assignments.map(a => `
                            <td class="p-2 text-center border-l border-slate-50/50">
                                <label class="cursor-pointer relative flex justify-center items-center h-full w-full">
                                    <input type="checkbox" 
                                        ${!s.missing.includes(a.id) ? 'checked' : ''} 
                                        onchange="toggleMissing(${s.id}, '${a.id}')"
                                        class="peer sr-only">
                                    <div class="w-6 h-6 rounded-lg border-2 border-slate-200 peer-checked:bg-teal-500 peer-checked:border-teal-500 transition-all flex items-center justify-center text-white transform peer-checked:scale-110">
                                        <i data-lucide="check" class="w-4 h-4"></i>
                                    </div>
                                </label>
                            </td>
                        `).join('')}
            <td class="p-4">
                            ${isComplete
                        ? '<span class="inline-flex items-center gap-1 px-2.5 py-1 rounded-lg bg-teal-50 text-teal-600 text-xs font-bold border border-teal-100"><i data-lucide="check-circle-2" class="w-3 h-3"></i> ครบถ้วน</span>'
                        : `<span class="inline-flex items-center gap-1 px-2.5 py-1 rounded-lg bg-rose-50 text-rose-600 text-xs font-bold border border-rose-100"><i data-lucide="alert-circle" class="w-3 h-3"></i> ขาด ${missingCount}</span>`
                    }
                        </td>
                        <td class="p-4 text-right flex items-center justify-end gap-2">
                            <button onclick="markAllComplete(${s.id})" class="text-slate-300 hover:text-teal-500 transition-colors opacity-0 group-hover:opacity-100 p-2 hover:bg-teal-50 rounded-lg" title="ส่งครบทุกงาน">
                                <i data-lucide="check-check" class="w-4 h-4"></i>
                            </button>
                            <button onclick="editStudent(${s.id})" class="text-slate-300 hover:text-amber-500 transition-colors opacity-0 group-hover:opacity-100 p-2 hover:bg-amber-50 rounded-lg" title="แก้ไขชื่อ">
                                <i data-lucide="pencil" class="w-4 h-4"></i>
                            </button>
                            <button onclick="removeStudent(${s.id})" class="text-slate-300 hover:text-rose-500 transition-colors opacity-0 group-hover:opacity-100 p-2 hover:bg-rose-50 rounded-lg" title="ลบรายชื่อ">
                                <i data-lucide="trash-2" class="w-4 h-4"></i>
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
            lucide.createIcons();
        }

        // Set to track expanded cards
        const expandedStudentIds = new Set();

        function toggleCard(studentId) {
            const content = document.getElementById(`card-content-${studentId}`);
            const chevron = document.getElementById(`chevron-${studentId}`);

            if (content.classList.contains('expanded')) {
                content.classList.remove('expanded');
                chevron.classList.remove('rotated');
                expandedStudentIds.delete(studentId);
            } else {
                content.classList.add('expanded');
                chevron.classList.add('rotated');
                expandedStudentIds.add(studentId);
            }
        }

        function renderMobileCards() {
            const container = document.getElementById('mobileStudentList');
            const currentSubject = appData.subjects.find(s => s.id === appData.currentSubjectId);

            if (!currentSubject) return;

            const searchTerm = document.getElementById('searchInput')?.value.trim().toLowerCase() || '';
            const sortOption = document.getElementById('sortSelect')?.value || 'default';

            let filteredStudents = appData.students.filter(s => s.name.toLowerCase().includes(searchTerm));

            // Sorting Logic (Same as Table)
            if (sortOption === 'most_missing') {
                filteredStudents.sort((a, b) => {
                    const missingA = a.missing.filter(m => currentSubject.assignments.some(assign => assign.id === m)).length;
                    const missingB = b.missing.filter(m => currentSubject.assignments.some(assign => assign.id === m)).length;
                    return missingB - missingA;
                });
            } else if (sortOption === 'least_missing') {
                filteredStudents.sort((a, b) => {
                    const missingA = a.missing.filter(m => currentSubject.assignments.some(assign => assign.id === m)).length;
                    const missingB = b.missing.filter(m => currentSubject.assignments.some(assign => assign.id === m)).length;
                    return missingA - missingB;
                });
            } else {
                filteredStudents.sort((a, b) => a.id - b.id);
            }

            if (filteredStudents.length === 0) {
                container.innerHTML = `<div class="text-center text-slate-400 py-8 italic">ไม่พบรายชื่อนักเรียน</div>`;
                return;
            }

            container.innerHTML = filteredStudents.map(s => {
                const totalAssignments = currentSubject.assignments.length;
                const missingCount = s.missing.filter(m => currentSubject.assignments.some(a => a.id === m)).length;
                const completedCount = totalAssignments - missingCount;
                const progressPercent = totalAssignments === 0 ? 0 : (completedCount / totalAssignments) * 100;
                const isComplete = missingCount === 0;
                const isExpanded = expandedStudentIds.has(s.id);

                return `
                    <div class="bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden">
                        <!-- Card Header -->
                        <div class="p-4 flex items-center justify-between bg-white cursor-pointer" onclick="toggleCard(${s.id})">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 rounded-full flex items-center justify-center font-bold text-slate-600 ${isComplete ? 'bg-teal-50 text-teal-600' : 'bg-rose-50 text-rose-600'}">
                                    ${s.name.charAt(0)}
                                </div>
                                <div>
                                    <div class="font-bold text-slate-800">${s.name}</div>
                                    <div class="text-xs ${isComplete ? 'text-teal-500' : 'text-rose-500'} font-medium flex items-center gap-1">
                                        ${isComplete
                        ? '<i data-lucide="check-circle-2" class="w-3 h-3"></i> ส่งครบแล้ว'
                        : `<i data-lucide="alert-circle" class="w-3 h-3"></i> ค้าง ${missingCount} งาน`}
                                    </div>
                                </div>
                            </div>
                            <!-- Progress Bar -->
                            <div class="h-1 w-full bg-slate-100 absolute bottom-0 left-0">
                                <div class="h-full bg-teal-500 transition-all duration-500" style="width: ${progressPercent}%"></div>
                            </div>
                            <i data-lucide="chevron-down" id="chevron-${s.id}" class="w-5 h-5 text-slate-400 chevron ${isExpanded ? 'rotated' : ''}"></i>
                        </div>

                        <!-- Card Content (Accordion) -->
                        <div id="card-content-${s.id}" class="accordion-content ${isExpanded ? 'expanded' : ''} border-t border-slate-100 bg-slate-50/50">
                            <div class="accordion-inner">
                                <div class="p-3 space-y-2">
                                    ${currentSubject.assignments.map(a => `
                                        <div class="flex items-center justify-between p-3 bg-white rounded-lg border border-slate-100">
                                            <div class="flex-1">
                                                <div class="text-sm font-bold text-slate-700">${a.title}</div>
                                                <div class="text-xs text-slate-400">${a.desc}</div>
                                            </div>
                                            <label class="cursor-pointer relative flex items-center justify-center w-8 h-8">
                                                <input type="checkbox" 
                                                    ${!s.missing.includes(a.id) ? 'checked' : ''} 
                                                    onchange="toggleMissing(${s.id}, '${a.id}')"
                                                    class="peer sr-only">
                                                <div class="w-6 h-6 rounded-md border-2 border-slate-200 peer-checked:bg-teal-500 peer-checked:border-teal-500 transition-all flex items-center justify-center text-white">
                                                    <i data-lucide="check" class="w-4 h-4"></i>
                                                </div>
                                            </label>
                                        </div>
                                    `).join('')}
                                    <div class="pt-2 flex justify-between items-center border-t border-slate-100 mt-2">
                                        <button onclick="markAllComplete(${s.id})" class="text-teal-600 text-xs font-bold flex items-center gap-1 px-3 py-2 rounded-lg hover:bg-teal-50 transition-colors">
                                            <i data-lucide="check-check" class="w-3 h-3"></i> ส่งครบทุกงาน
                                        </button>
                                        <button onclick="editStudent(${s.id})" class="text-amber-500 text-xs font-bold flex items-center gap-1 px-3 py-2 rounded-lg hover:bg-amber-50 transition-colors">
                                            <i data-lucide="pencil" class="w-3 h-3"></i> แก้ไขชื่อ
                                        </button>
                                        <button onclick="removeStudent(${s.id})" class="text-rose-500 text-xs font-bold flex items-center gap-1 px-3 py-2 rounded-lg hover:bg-rose-50 transition-colors">
                                            <i data-lucide="trash-2" class="w-3 h-3"></i> ลบรายชื่อ
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            lucide.createIcons();
        }

        function renderManageModal() {
            const list = document.getElementById('manageSubjectsList');
            if (!list) return;

            list.innerHTML = appData.subjects.map((sub, idx) => `
                <div class="bg-white border border-slate-200 rounded-xl overflow-hidden shadow-sm animate-entry" style="animation-delay: ${idx * 0.05}s">
                    <div class="bg-slate-50 p-3 flex justify-between items-center border-b border-slate-100">
                        <h4 class="font-bold text-slate-700 flex items-center gap-2">
                            <span class="w-2 h-2 rounded-full bg-teal-500"></span>
                            ${sub.name}
                        </h4>
                        <div class="flex gap-2">
                            <button onclick="editSubject('${sub.id}')" class="btn-press text-slate-400 hover:text-amber-500 text-xs flex items-center gap-1 bg-white border border-slate-200 px-2 py-1 rounded-lg hover:border-amber-200">
                                <i data-lucide="pencil" class="w-3 h-3"></i> แก้ไข
                            </button>
                            <button onclick="deleteSubject('${sub.id}')" class="btn-press text-slate-400 hover:text-rose-500 text-xs flex items-center gap-1 bg-white border border-slate-200 px-2 py-1 rounded-lg hover:border-rose-200">
                                <i data-lucide="trash" class="w-3 h-3"></i> ลบวิชา
                            </button>
                        </div>
                    </div>
                    <div class="p-3 space-y-3">
                        <!-- Assignments List -->
                        <div class="space-y-2">
                            ${sub.assignments.map((work, idx) => `
                                <div class="flex items-center gap-2 text-sm group hover:bg-slate-50 p-2 rounded-lg transition-colors">
                                    <span class="text-slate-400 font-mono text-xs w-6">${idx + 1}.</span>
                                    <div class="flex-1">
                                        <div class="font-bold text-slate-700">${work.title}</div>
                                        <div class="text-xs text-slate-500">${work.desc}</div>
                                    </div>
                                    <div class="flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                                        <button onclick="editAssignment('${sub.id}', '${work.id}')" class="text-slate-300 hover:text-amber-500 p-1">
                                            <i data-lucide="pencil" class="w-4 h-4"></i>
                                        </button>
                                        <button onclick="deleteAssignment('${sub.id}', '${work.id}')" class="text-slate-300 hover:text-rose-500 p-1">
                                            <i data-lucide="x-circle" class="w-4 h-4"></i>
                                        </button>
                                    </div>
                                </div>
                            `).join('')}
                            ${sub.assignments.length === 0 ? '<div class="text-xs text-slate-400 italic text-center py-2">ยังไม่มีงาน</div>' : ''}
                        </div>

                        <!-- Add Assignment Form -->
                        <form onsubmit="event.preventDefault(); addAssignment('${sub.id}', this.title.value, this.desc.value); this.reset();" class="mt-3 pt-3 border-t border-slate-100 flex flex-col gap-2">
                            <input name="title" type="text" placeholder="ชื่องาน (เช่น งานที่ 1)" required aria-label="ชื่องาน"
                                class="w-full p-2 border border-slate-200 rounded-lg text-xs focus:outline-none focus:border-teal-500 focus:ring-1 focus:ring-teal-500 transition-all">
                            <div class="flex gap-2">
                                <input name="desc" type="text" placeholder="รายละเอียด (เช่น สรุปบทที่ 1)" required aria-label="รายละเอียดงาน"
                                    class="flex-1 p-2 border border-slate-200 rounded-lg text-xs focus:outline-none focus:border-teal-500 focus:ring-1 focus:ring-teal-500 transition-all">
                                <button type="submit" class="btn-press bg-slate-800 text-white px-3 py-1 rounded-lg text-xs font-bold hover:bg-slate-700 shadow-md">เพิ่ม</button>
                            </div>
                        </form>
                    </div>
                </div>
            `).join('');
            lucide.createIcons();
        }

        // --- Action Functions ---
        function switchSubject(subjectId) {
            appData.currentSubjectId = subjectId;
            saveData();
            renderApp();
        }

        function toggleMissing(studentId, assignmentId) {
            const student = appData.students.find(s => s.id === studentId);
            if (!student) return;

            if (student.missing.includes(assignmentId)) {
                student.missing = student.missing.filter(m => m !== assignmentId);
            } else {
                student.missing.push(assignmentId);
            }

            saveData();
            renderApp();
        }

        function removeStudent(id) {
            showConfirmModal(
                'ลบรายชื่อนักเรียน?',
                'ข้อมูลการส่งงานของนักเรียนคนนี้จะหายไป',
                () => {
                    appData.students = appData.students.filter(s => s.id !== id);
                    saveData();
                    renderApp();
                    showToast('ลบรายชื่อเรียบร้อย');
                }
            );
        }

        function handleAddSubject(e) {
            e.preventDefault();
            const input = document.getElementById('newSubjectInput');
            const name = input.value.trim();
            if (!name) return;

            const newId = 'sub_' + Date.now();
            appData.subjects.push({
                id: newId,
                name: name,
                assignments: []
            });

            saveData();
            renderApp();
            input.value = '';
            showToast(`เพิ่มวิชา "${name}" แล้ว`);
        }

        function deleteSubject(id) {
            showConfirmModal(
                'ลบวิชานี้?',
                'ข้อมูลงานและการส่งงานทั้งหมดในวิชานี้จะหายไป',
                () => {
                    appData.subjects = appData.subjects.filter(s => s.id !== id);
                    if (appData.currentSubjectId === id) {
                        appData.currentSubjectId = appData.subjects[0]?.id || '';
                    }
                    saveData();
                    renderApp();
                    showToast('ลบวิชาเรียบร้อย');
                }
            );
        }

        function addAssignment(subjectId, title, desc) {
            const subject = appData.subjects.find(s => s.id === subjectId);
            if (!subject) return;

            const newId = 'w_' + Date.now();
            subject.assignments.push({ id: newId, title, desc });

            // Add to missing list for all students (Default Incomplete)
            appData.students.forEach(s => {
                if (!s.missing.includes(newId)) {
                    s.missing.push(newId);
                }
            });

            saveData();
            renderApp();
            showToast('เพิ่มงานเรียบร้อย');
        }

        function deleteAssignment(subjectId, assignmentId) {
            const subject = appData.subjects.find(s => s.id === subjectId);
            if (!subject) return;

            showConfirmModal(
                'ลบงานนี้?',
                'ข้อมูลการส่งงานของนักเรียนทุกคนในงานนี้จะหายไป',
                () => {
                    subject.assignments = subject.assignments.filter(a => a.id !== assignmentId);
                    // Remove from missing lists
                    appData.students.forEach(s => {
                        s.missing = s.missing.filter(m => m !== assignmentId);
                    });
                    saveData();
                    renderApp();
                    showToast('ลบงานเรียบร้อย');
                }
            );
        }

        function editStudent(id) {
            const student = appData.students.find(s => s.id === id);
            if (!student) return;

            const newName = prompt("แก้ไขชื่อนักเรียน:", student.name);
            if (newName && newName.trim() !== "") {
                student.name = newName.trim();
                saveData();
                renderApp();
                showToast("แก้ไขชื่อเรียบร้อย");
            }
        }

        function editSubject(id) {
            const subject = appData.subjects.find(s => s.id === id);
            if (!subject) return;

            const newName = prompt("แก้ไขชื่อวิชา:", subject.name);
            if (newName && newName.trim() !== "") {
                subject.name = newName.trim();
                saveData();
                renderApp();
                showToast("แก้ไขชื่อวิชาเรียบร้อย");
            }
        }

        function editAssignment(subId, workId) {
            const subject = appData.subjects.find(s => s.id === subId);
            if (!subject) return;
            const assignment = subject.assignments.find(a => a.id === workId);
            if (!assignment) return;

            const newTitle = prompt("แก้ไขชื่องาน:", assignment.title);
            if (newTitle !== null) {
                const newDesc = prompt("แก้ไขรายละเอียด:", assignment.desc);
                if (newDesc !== null) {
                    assignment.title = newTitle.trim() || assignment.title;
                    assignment.desc = newDesc.trim() || assignment.desc;
                    saveData();
                    renderApp();
                    showToast("แก้ไขงานเรียบร้อย");
                }
            }
        }

        // --- UI Utilities ---
        function showToast(message, type = 'success') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `
                <i data-lucide="${type === 'success' ? 'check-circle' : 'alert-circle'}" class="w-6 h-6 ${type === 'success' ? 'text-teal-500' : 'text-rose-500'}"></i>
                <div class="font-bold text-slate-700">${message}</div>
            `;
            container.appendChild(toast);
            lucide.createIcons();

            setTimeout(() => {
                toast.style.animation = 'fadeOut 0.3s ease-out forwards';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        function openManageModal() {
            const modal = document.getElementById('manageModal');
            const backdrop = document.getElementById('manageBackdrop');
            const content = document.getElementById('manageContent');

            modal.classList.remove('hidden');
            modal.classList.add('flex');
            renderManageModal();

            // Animate In
            setTimeout(() => {
                backdrop.classList.remove('opacity-0');
                content.classList.remove('opacity-0', 'scale-95');
                content.classList.add('scale-100');
            }, 10);
        }

        function closeManageModal() {
            const modal = document.getElementById('manageModal');
            const backdrop = document.getElementById('manageBackdrop');
            const content = document.getElementById('manageContent');

            backdrop.classList.add('opacity-0');
            content.classList.add('opacity-0', 'scale-95');
            content.classList.remove('scale-100');

            setTimeout(() => {
                modal.classList.add('hidden');
                modal.classList.remove('flex');
            }, 300);
        }

        function showConfirmModal(title, message, onConfirm) {
            const modal = document.getElementById('confirmModal');
            const backdrop = document.getElementById('confirmBackdrop');
            const content = document.getElementById('confirmContent');
            const titleEl = document.getElementById('confirmTitle');
            const msgEl = document.getElementById('confirmMessage');
            const cancelBtn = document.getElementById('confirmCancelBtn');
            const okBtn = document.getElementById('confirmOkBtn');

            titleEl.innerText = title;
            msgEl.innerText = message;

            modal.classList.remove('hidden');
            modal.classList.add('flex');

            setTimeout(() => {
                backdrop.classList.remove('opacity-0');
                content.classList.remove('opacity-0', 'scale-95');
                content.classList.add('scale-100');
            }, 10);

            const close = () => {
                backdrop.classList.add('opacity-0');
                content.classList.add('opacity-0', 'scale-95');
                content.classList.remove('scale-100');
                setTimeout(() => {
                    modal.classList.add('hidden');
                    modal.classList.remove('flex');
                }, 300);
                okBtn.onclick = null;
                cancelBtn.onclick = null;
            };

            cancelBtn.onclick = close;
            okBtn.onclick = () => {
                onConfirm();
                close();
            };
        }
    </script>
</body>

</html>