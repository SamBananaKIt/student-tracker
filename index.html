<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Elite Tracker - รายชื่อนักเรียน</title>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Elite Tracker">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/3135/3135715.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { sans: ['Sarabun', 'sans-serif'], display: ['Outfit', 'sans-serif'] },
                    colors: {
                        gold: { 50: '#fbf7eb', 100: '#f5eccd', 200: '#ebd696', 300: '#dfbd5d', 400: '#d4a132', 500: '#b8861c', 600: '#966613', 700: '#784d11', 800: '#633e15', 900: '#553516', 950: '#301b08' },
                        obsidian: { 800: '#18181b', 900: '#09090b', 950: '#020203' }
                    },
                    boxShadow: {
                        glow: '0 0 20px rgba(184, 134, 28, 0.15)',
                        'glow-lg': '0 0 30px rgba(184, 134, 28, 0.25)'
                    }
                }
            }
        }
    </script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link
        href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&family=Outfit:wght@400;500;700&display=swap"
        rel="stylesheet">
    <style>
        body {
            font-family: 'Sarabun', sans-serif;
        }

        h1,
        h2,
        h3,
        .font-display {
            font-family: 'Outfit', sans-serif;
        }

        .glass-panel {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.6);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.06);
        }

        .dark .glass-panel {
            background: rgba(12, 12, 16, 0.7);
            border: 1px solid rgba(255, 255, 255, 0.08);
        }

        .mesh-bg {
            position: fixed;
            inset: 0;
            background: radial-gradient(40% 40% at 20% 20%, rgba(184, 134, 28, 0.12), transparent),
                radial-gradient(30% 30% at 80% 0%, rgba(0, 0, 0, 0.08), transparent),
                radial-gradient(50% 50% at 80% 80%, rgba(88, 28, 135, 0.08), transparent);
            pointer-events: none;
            z-index: 0;
        }

        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 10px;
        }

        .dark ::-webkit-scrollbar-thumb {
            background: #3f3f46;
        }

        #toast-container {
            position: fixed;
            bottom: 24px;
            right: 24px;
            z-index: 100;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .toast {
            background: white;
            border: 1px solid #e2e8f0;
            padding: 16px 20px;
            border-radius: 16px;
            box-shadow: 0 10px 40px -10px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            gap: 12px;
            animation: slideInRight 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards;
            min-width: 300px;
        }

        .dark .toast {
            background: #18181b;
            border-color: #27272a;
            color: #f4f4f5;
            box-shadow: 0 10px 40px -10px rgba(0, 0, 0, 0.5);
        }

        .btn-premium {
            transition: all 0.2s ease;
        }

        .btn-premium:active {
            transform: scale(0.97);
        }

        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
    </style>
</head>

<body class="min-h-screen bg-gradient-to-br from-amber-50 via-white to-slate-100 dark:from-slate-950 dark:via-obsidian-900 dark:to-black text-slate-800 dark:text-slate-100">
    <div class="mesh-bg"></div>

    <div class="relative z-10 max-w-6xl mx-auto px-4 py-6 space-y-6">
        <header class="flex flex-col gap-4 sm:flex-row sm:items-center sm:justify-between">
            <div>
                <p class="text-xs uppercase tracking-[0.3em] text-slate-400">Elite Tracker</p>
                <h1 class="text-3xl sm:text-4xl font-display font-bold text-slate-900 dark:text-white mt-1">รายการงานค้างของนักเรียน</h1>
                <p class="text-sm text-slate-500 dark:text-slate-400">แตะชื่อเพื่อดูรายละเอียดงานที่ค้าง</p>
            </div>
            <div class="flex items-center gap-3">
                <button id="themeToggle"
                    class="p-3 rounded-xl border border-gray-200 dark:border-white/10 bg-white dark:bg-white/5 hover:border-gold-300 hover:text-gold-600 transition">
                    <i data-lucide="moon" class="w-5 h-5"></i>
                </button>
                <button onclick="openManageModal()"
                    class="px-4 py-3 rounded-xl bg-gradient-to-r from-gold-500 to-gold-600 text-white font-semibold shadow-glow-lg hover:shadow-glow transition">
                    จัดการวิชา
                </button>
            </div>
        </header>

        <section class="glass-panel p-4 sm:p-6 rounded-3xl border border-white/60 dark:border-white/10 shadow-glow">
            <div class="flex flex-col sm:flex-row sm:items-end sm:justify-between gap-4">
                <div class="space-y-2">
                    <div class="text-xs uppercase text-slate-400 font-semibold tracking-[0.2em]">วิชา</div>
                    <div id="subjectTabs" class="flex flex-wrap gap-2"></div>
                </div>
                <form id="addStudentForm" class="flex flex-col sm:flex-row gap-3 w-full sm:w-auto">
                    <input id="studentName" name="studentName" type="text" placeholder="เพิ่มชื่อนักเรียน"
                        class="flex-1 sm:w-64 px-3 py-2 rounded-xl border border-gray-200 dark:border-white/10 bg-white/80 dark:bg-black/30 focus:outline-none focus:ring-2 focus:ring-gold-400"
                        required>
                    <button type="submit"
                        class="px-4 py-2 rounded-xl border border-gold-200 text-gold-700 bg-gold-50 hover:bg-gold-100 dark:border-gold-500/30 dark:text-gold-200 dark:bg-gold-900/20">
                        เพิ่มนักเรียน
                    </button>
                </form>
            </div>

            <div class="mt-6 space-y-4">
                <div class="lg:hidden">
                    <div class="flex items-center justify-between mb-2">
                        <h2 class="text-lg font-semibold text-slate-800 dark:text-white">รายชื่อนักเรียน (แตะเพื่อขยาย)</h2>
                        <span class="text-xs px-2 py-1 rounded-full bg-amber-100 text-amber-700 dark:bg-amber-900/30 dark:text-amber-200">โมบาย</span>
                    </div>
                    <div id="mobileCards" class="space-y-3"></div>
                </div>

                <div class="hidden lg:block">
                    <div class="flex items-center justify-between mb-3">
                        <h2 class="text-lg font-semibold text-slate-800 dark:text-white">รายชื่อนักเรียน</h2>
                        <span class="text-xs px-2 py-1 rounded-full bg-slate-100 text-slate-600 dark:bg-white/10 dark:text-white/70">เดสก์ท็อป</span>
                    </div>
                    <div class="overflow-hidden rounded-2xl border border-gray-200/70 dark:border-white/10 bg-white/80 dark:bg-white/5">
                        <table class="min-w-full text-sm">
                            <thead class="bg-gray-50 dark:bg-white/5 text-slate-500 dark:text-slate-300">
                                <tr>
                                    <th class="text-left px-4 py-3 font-semibold">ชื่อ</th>
                                    <th class="text-left px-4 py-3 font-semibold">สถานะ</th>
                                    <th class="text-left px-4 py-3 font-semibold">งานค้าง</th>
                                    <th class="text-right px-4 py-3 font-semibold">จัดการ</th>
                                </tr>
                            </thead>
                            <tbody id="studentTableBody" class="divide-y divide-gray-100 dark:divide-white/5"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </section>
    </div>

    <div id="manageModal" class="fixed inset-0 hidden items-center justify-center z-30">
        <div id="manageBackdrop" class="absolute inset-0 bg-black/50 backdrop-blur-sm opacity-0 transition"></div>
        <div id="manageContent"
            class="relative max-w-3xl w-full mx-4 bg-white dark:bg-[#0b0b0f] rounded-3xl shadow-2xl border border-gray-100 dark:border-white/10 overflow-hidden opacity-0 scale-95 transition">
            <div class="p-6 border-b border-gray-100 dark:border-white/10 flex justify-between items-center">
                <div>
                    <h2 class="text-2xl font-display font-bold text-slate-800 dark:text-white">จัดการวิชาและงาน</h2>
                    <p class="text-sm text-slate-500 dark:text-slate-400">เพิ่มวิชาและรายการงานที่ต้องตรวจสอบ</p>
                </div>
                <button onclick="closeManageModal()"
                    class="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-white/10 text-gray-500"><i data-lucide="x"
                        class="w-5 h-5"></i></button>
            </div>
            <div class="p-6 space-y-4 max-h-[70vh] overflow-y-auto" id="manageSubjectsList"></div>
            <div class="p-6 border-t border-gray-100 dark:border-white/10 bg-gray-50/60 dark:bg-white/5">
                <form onsubmit="handleAddSubject(event)" class="flex gap-3">
                    <input id="newSubjectInput" type="text" placeholder="ชื่อวิชาใหม่"
                        class="flex-1 px-3 py-2 rounded-xl border border-gray-200 dark:border-white/10 bg-white dark:bg-black/30 focus:ring-2 focus:ring-gold-400"
                        required>
                    <button type="submit"
                        class="px-4 py-2 rounded-xl bg-gold-500 text-white font-semibold hover:bg-gold-600 btn-premium">เพิ่มวิชา</button>
                </form>
            </div>
        </div>
    </div>

    <div id="studentDetailModal" class="fixed inset-0 hidden items-center justify-center z-40">
        <div id="detailBackdrop" class="absolute inset-0 bg-black/50 backdrop-blur-sm opacity-0 transition"></div>
        <div id="detailContent"
            class="relative max-w-xl w-full mx-4 bg-white dark:bg-[#0b0b0f] rounded-3xl shadow-2xl border border-gray-100 dark:border-white/10 overflow-hidden opacity-0 scale-95 transition">
            <div id="studentDetailBody" class="flex flex-col max-h-[80vh]"></div>
        </div>
    </div>

    <div id="confirmModal" class="fixed inset-0 hidden items-center justify-center z-50">
        <div id="confirmBackdrop" class="absolute inset-0 bg-black/50 backdrop-blur-sm opacity-0 transition"></div>
        <div id="confirmContent"
            class="relative w-full max-w-sm mx-4 bg-white dark:bg-[#0b0b0f] rounded-2xl shadow-2xl border border-gray-100 dark:border-white/10 p-6 opacity-0 scale-95 transition">
            <div class="flex items-start gap-3">
                <div class="p-2 rounded-xl bg-amber-100 text-amber-600 dark:bg-amber-900/30"><i data-lucide="alert-circle"
                        class="w-5 h-5"></i></div>
                <div class="flex-1">
                    <h3 id="confirmTitle" class="text-lg font-semibold text-slate-800 dark:text-white"></h3>
                    <p id="confirmMessage" class="text-sm text-slate-500 dark:text-slate-300 mt-1"></p>
                </div>
            </div>
            <div class="mt-6 flex justify-end gap-2">
                <button id="confirmCancelBtn"
                    class="px-4 py-2 rounded-xl border border-gray-200 dark:border-white/10 text-slate-600 dark:text-slate-200">ยกเลิก</button>
                <button id="confirmOkBtn"
                    class="px-4 py-2 rounded-xl bg-rose-500 text-white font-semibold hover:bg-rose-600">ดำเนินการ</button>
            </div>
        </div>
    </div>

    <div id="toast-container"></div>

    <script>
        const STORAGE_KEY = 'elite-tracker-data';
        const defaultData = {
            subjects: [
                {
                    id: 'sub_default',
                    name: 'คณิตศาสตร์',
                    assignments: [
                        { id: 'a1', title: 'ใบงาน 1', desc: 'แบบฝึกหัดเศษส่วน' },
                        { id: 'a2', title: 'ใบงาน 2', desc: 'โจทย์สมการพื้นฐาน' },
                        { id: 'a3', title: 'แบบฝึกหัดเสริม', desc: 'การบ้านทบทวน' }
                    ]
                }
            ],
            students: [
                { id: 1, name: 'นาย ก', missing: ['a1', 'a3'] },
                { id: 2, name: 'นาง ข', missing: ['a2'] },
                { id: 3, name: 'นาย ค', missing: [] }
            ],
            currentSubjectId: 'sub_default',
            settings: { theme: 'light' }
        };

        let appData = loadData();
        applyTheme(appData.settings?.theme || 'light');

        const addStudentForm = document.getElementById('addStudentForm');
        addStudentForm.addEventListener('submit', handleAddStudent);

        document.getElementById('themeToggle').addEventListener('click', () => {
            const newTheme = document.documentElement.classList.contains('dark') ? 'light' : 'dark';
            applyTheme(newTheme);
            appData.settings.theme = newTheme;
            saveData();
        });

        function loadData() {
            const saved = localStorage.getItem(STORAGE_KEY);
            if (!saved) return structuredClone(defaultData);
            try {
                const parsed = JSON.parse(saved);
                return { ...structuredClone(defaultData), ...parsed };
            } catch (e) {
                console.warn('Cannot parse saved data, using default.', e);
                return structuredClone(defaultData);
            }
        }

        function saveData() {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(appData));
        }

        function applyTheme(mode) {
            if (mode === 'dark') {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
            const themeBtnIcon = document.getElementById('themeToggle').querySelector('i');
            themeBtnIcon.setAttribute('data-lucide', mode === 'dark' ? 'sun' : 'moon');
            lucide.createIcons();
        }

        function currentSubject() {
            return appData.subjects.find(s => s.id === appData.currentSubjectId) || appData.subjects[0];
        }

        function renderTabs() {
            const tabs = document.getElementById('subjectTabs');
            if (!appData.subjects.length) {
                tabs.innerHTML = '<div class="text-sm text-rose-500">โปรดเพิ่มวิชาอย่างน้อย 1 วิชา</div>';
                return;
            }
            tabs.innerHTML = appData.subjects.map(sub => {
                const isActive = sub.id === currentSubject().id;
                return `
                    <button onclick="switchSubject('${sub.id}')"
                        class="px-4 py-2 rounded-xl border text-sm font-semibold transition ${isActive
                        ? 'border-gold-400 text-gold-700 bg-gold-50 dark:border-gold-500/40 dark:text-gold-200 dark:bg-gold-900/20'
                        : 'border-gray-200 text-slate-600 hover:border-gold-300 dark:border-white/10 dark:text-slate-200 dark:hover:border-gold-400/40'}">
                        ${sub.name} (${sub.assignments.length})
                    </button>
                `;
            }).join('');
        }

        function renderMobileCards() {
            const container = document.getElementById('mobileCards');
            const subject = currentSubject();
            if (!subject) {
                container.innerHTML = '<div class="text-sm text-rose-500">ยังไม่มีข้อมูลวิชา</div>';
                return;
            }

            container.innerHTML = appData.students.map(student => {
                const missing = subject.assignments.filter(a => student.missing.includes(a.id));
                const missingCount = missing.length;
                const total = subject.assignments.length || 0;
                const statusText = total === 0 ? 'ยังไม่มีงาน' : missingCount === 0 ? 'ครบแล้ว' : `${missingCount}/${total} ค้าง`;
                const statusClass = missingCount === 0
                    ? 'bg-emerald-100 text-emerald-700 dark:bg-emerald-900/30 dark:text-emerald-300'
                    : 'bg-amber-100 text-amber-700 dark:bg-amber-900/30 dark:text-amber-200';
                return `
                    <div class="bg-white/90 dark:bg-white/5 border border-gray-200/70 dark:border-white/10 rounded-2xl shadow-sm overflow-hidden">
                        <button type="button" onclick="toggleCard(${student.id})"
                            class="w-full flex items-center justify-between px-4 py-3">
                            <div class="text-left">
                                <div class="font-semibold text-lg text-slate-800 dark:text-white">${student.name}</div>
                                <div class="text-xs text-slate-500 dark:text-slate-400">แตะเพื่อดูงานที่ค้าง</div>
                            </div>
                            <div class="flex items-center gap-2">
                                <span class="text-xs px-2 py-1 rounded-full ${statusClass}">${statusText}</span>
                                <i id="chevron-${student.id}" data-lucide="chevron-down"
                                    class="w-5 h-5 text-slate-500 transition-transform"></i>
                            </div>
                        </button>
                        <div id="card-content-${student.id}" class="hidden border-t border-gray-100 dark:border-white/5 bg-gray-50/60 dark:bg-black/20">
                            <div class="p-4 grid grid-cols-1 sm:grid-cols-2 gap-3">
                                ${subject.assignments.map(a => `
                                    <label class="flex items-center gap-3 p-3 rounded-xl border ${student.missing.includes(a.id)
                        ? 'border-gray-200 dark:border-white/10'
                        : 'border-emerald-200 bg-emerald-50 dark:border-emerald-500/30 dark:bg-emerald-900/20'}">
                                        <input type="checkbox" ${student.missing.includes(a.id) ? '' : 'checked'}
                                            onchange="toggleMissing(${student.id}, '${a.id}')"
                                            class="h-4 w-4 rounded border-gray-300 text-gold-500 focus:ring-gold-400">
                                        <div>
                                            <div class="font-semibold text-sm text-slate-800 dark:text-white">${a.title}</div>
                                            <div class="text-xs text-slate-500 dark:text-slate-400">${a.desc}</div>
                                        </div>
                                    </label>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            lucide.createIcons();
        }

        function renderTable() {
            const tbody = document.getElementById('studentTableBody');
            const subject = currentSubject();
            if (!subject) {
                tbody.innerHTML = '';
                return;
            }
            tbody.innerHTML = appData.students.map(student => {
                const missingCount = subject.assignments.filter(a => student.missing.includes(a.id)).length;
                const total = subject.assignments.length || 0;
                const progress = total === 0 ? 0 : Math.round(((total - missingCount) / total) * 100);
                return `
                    <tr class="hover:bg-amber-50/40 dark:hover:bg-white/5 transition">
                        <td class="px-4 py-3">
                            <button class="text-left font-semibold text-slate-800 dark:text-white hover:text-gold-600"
                                onclick="openStudentModal(${student.id})">${student.name}</button>
                            <div class="text-xs text-slate-400">แตะเพื่อดูรายละเอียด</div>
                        </td>
                        <td class="px-4 py-3">
                            <div class="flex items-center gap-2">
                                <div class="w-32 h-2 bg-gray-100 dark:bg-white/5 rounded-full overflow-hidden">
                                    <div class="h-full ${progress === 100 ? 'bg-emerald-500' : 'bg-gold-500'}" style="width:${progress}%"></div>
                                </div>
                                <span class="text-xs text-slate-500 dark:text-slate-300">${progress}%</span>
                            </div>
                        </td>
                        <td class="px-4 py-3">
                            <span class="px-2 py-1 text-xs rounded-full ${missingCount === 0
                        ? 'bg-emerald-100 text-emerald-700 dark:bg-emerald-900/30 dark:text-emerald-200'
                        : 'bg-amber-100 text-amber-700 dark:bg-amber-900/30 dark:text-amber-200'}">
                                ${missingCount === 0 ? 'ครบแล้ว' : `ค้าง ${missingCount} งาน`}
                            </span>
                        </td>
                        <td class="px-4 py-3 text-right">
                            <div class="flex items-center justify-end gap-2">
                                <button title="Mark all complete" onclick="markAllComplete(${student.id})"
                                    class="p-2 rounded-lg border border-emerald-200 text-emerald-600 hover:bg-emerald-50 dark:border-emerald-500/30 dark:text-emerald-300 dark:hover:bg-emerald-900/20"><i data-lucide="check-circle" class="w-4 h-4"></i></button>
                                <button title="แก้ไขชื่อ" onclick="editStudent(${student.id})"
                                    class="p-2 rounded-lg border border-gray-200 text-slate-500 hover:bg-gray-50 dark:border-white/10 dark:text-slate-300 dark:hover:bg-white/5"><i data-lucide="pencil" class="w-4 h-4"></i></button>
                                <button title="ลบ" onclick="removeStudent(${student.id})"
                                    class="p-2 rounded-lg border border-rose-200 text-rose-500 hover:bg-rose-50 dark:border-rose-500/30 dark:text-rose-300 dark:hover:bg-rose-900/20"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
            lucide.createIcons();
        }

        function renderApp() {
            renderTabs();
            renderMobileCards();
            renderTable();
        }

        function switchSubject(id) {
            appData.currentSubjectId = id;
            saveData();
            renderApp();
        }

        function handleAddStudent(e) {
            e.preventDefault();
            const input = document.getElementById('studentName');
            const name = input.value.trim();
            if (!name) return;
            const newId = Date.now();
            const subjectAssignments = currentSubject()?.assignments || [];
            const missing = subjectAssignments.map(a => a.id);
            appData.students.push({ id: newId, name, missing });
            saveData();
            renderApp();
            input.value = '';
            showToast('เพิ่มนักเรียนแล้ว');
        }

        function toggleMissing(studentId, assignmentId) {
            const student = appData.students.find(s => s.id === studentId);
            if (!student) return;
            if (student.missing.includes(assignmentId)) {
                student.missing = student.missing.filter(m => m !== assignmentId);
            } else {
                student.missing.push(assignmentId);
            }
            saveData();
            renderApp();
        }

        function markAllComplete(studentId) {
            const subject = currentSubject();
            const student = appData.students.find(s => s.id === studentId);
            if (!student || !subject) return;
            subject.assignments.forEach(a => {
                student.missing = student.missing.filter(m => m !== a.id);
            });
            saveData();
            renderApp();
            showToast('ทำงานครบทั้งหมดแล้ว');
        }

        function removeStudent(id) {
            showConfirmModal('ลบนักเรียน?', 'การลบนี้ไม่สามารถย้อนกลับได้', () => {
                appData.students = appData.students.filter(s => s.id !== id);
                saveData();
                renderApp();
                showToast('ลบนักเรียนแล้ว', 'error');
            });
        }

        function editStudent(id) {
            const student = appData.students.find(s => s.id === id);
            if (!student) return;
            const newName = prompt('แก้ไขชื่อนักเรียน', student.name);
            if (newName && newName.trim() !== '') {
                student.name = newName.trim();
                saveData();
                renderApp();
                showToast('อัปเดตชื่อแล้ว');
            }
        }

        function toggleCard(id) {
            const content = document.getElementById(`card-content-${id}`);
            const chevron = document.getElementById(`chevron-${id}`);
            if (!content || !chevron) return;
            const hidden = content.classList.contains('hidden');
            content.classList.toggle('hidden');
            chevron.style.transform = hidden ? 'rotate(180deg)' : 'rotate(0deg)';
        }

        function openStudentModal(id) {
            const student = appData.students.find(s => s.id === id);
            const subject = currentSubject();
            if (!student || !subject) return;

            const modal = document.getElementById('studentDetailModal');
            const backdrop = document.getElementById('detailBackdrop');
            const content = document.getElementById('detailContent');
            const body = document.getElementById('studentDetailBody');

            const total = subject.assignments.length;
            const missingCount = subject.assignments.filter(a => student.missing.includes(a.id)).length;
            const completedCount = total - missingCount;
            const progress = total === 0 ? 0 : Math.round((completedCount / total) * 100);
            const dashArray = `${progress}, 100`;

            body.innerHTML = `
                <div class="p-6 border-b border-gray-100 dark:border-white/10 flex justify-between items-center bg-white/70 dark:bg-white/5">
                    <div>
                        <h2 class="text-2xl font-bold text-slate-800 dark:text-white font-display">${student.name}</h2>
                        <p class="text-sm text-gray-500 dark:text-gray-400">ID: ${student.id}</p>
                    </div>
                    <button onclick="closeStudentModal()"
                        class="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-white/10 transition-colors text-gray-500"><i data-lucide="x" class="w-6 h-6"></i></button>
                </div>
                <div class="p-6 overflow-y-auto flex-1 bg-gray-50/60 dark:bg-black/20 space-y-6">
                    <div class="flex items-center justify-center">
                        <div class="relative w-32 h-32">
                            <svg viewBox="0 0 36 36" class="circular-chart">
                                <path class="circle-bg"
                                    d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" />
                                <path class="circle" stroke="${progress >= 80 ? '#10b981' : (progress >= 50 ? '#f59e0b' : '#f43f5e')}"
                                    stroke-dasharray="${dashArray}"
                                    d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" />
                            </svg>
                            <div class="absolute inset-0 flex items-center justify-center flex-col">
                                <span class="text-2xl font-bold text-slate-800 dark:text-white">${progress}%</span>
                                <span class="text-[10px] uppercase tracking-wider text-gray-400">Complete</span>
                            </div>
                        </div>
                    </div>
                    <div class="space-y-3">
                        ${subject.assignments.map(a => `
                            <div onclick="toggleMissing(${student.id}, '${a.id}'); openStudentModal(${student.id})"
                                class="cursor-pointer p-4 rounded-xl border transition-all flex items-center justify-between group ${!student.missing.includes(a.id)
                    ? 'bg-emerald-50 dark:bg-emerald-900/10 border-emerald-200 dark:border-emerald-900/30'
                    : 'bg-white dark:bg-white/5 border-gray-200 dark:border-white/10 hover:border-gold-300 dark:hover:border-gold-500/30'}">
                                <div>
                                    <div class="font-bold text-sm ${!student.missing.includes(a.id) ? 'text-emerald-700 dark:text-emerald-400' : 'text-slate-700 dark:text-slate-200'}">
                                        ${a.title}</div>
                                    <div class="text-xs text-slate-400">${a.desc}</div>
                                </div>
                                <div class="w-6 h-6 rounded-full border-2 flex items-center justify-center transition-colors ${!student.missing.includes(a.id)
                    ? 'bg-emerald-500 border-emerald-500 text-white'
                    : 'border-gray-300 dark:border-gray-600 group-hover:border-gold-400'}">
                                    ${!student.missing.includes(a.id) ? '<i data-lucide="check" class="w-4 h-4"></i>' : ''}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
                <div class="p-6 border-t border-gray-100 dark:border-white/10 bg-white dark:bg-[#09090b]">
                    <button onclick="markAllComplete(${student.id}); closeStudentModal()"
                        class="w-full py-4 rounded-xl bg-gradient-to-r from-gold-500 to-gold-600 text-white font-bold shadow-lg shadow-gold-500/20 hover:shadow-gold-500/40 transition-all btn-premium">Mark All Complete</button>
                </div>
            `;

            modal.classList.remove('hidden');
            modal.classList.add('flex');
            setTimeout(() => {
                backdrop.classList.remove('opacity-0');
                content.classList.remove('opacity-0', 'scale-95');
            }, 10);
            lucide.createIcons();
        }

        function closeStudentModal() {
            const modal = document.getElementById('studentDetailModal');
            const backdrop = document.getElementById('detailBackdrop');
            const content = document.getElementById('detailContent');
            backdrop.classList.add('opacity-0');
            content.classList.add('opacity-0', 'scale-95');
            setTimeout(() => {
                modal.classList.add('hidden');
                modal.classList.remove('flex');
            }, 250);
        }

        function openManageModal() {
            const modal = document.getElementById('manageModal');
            const backdrop = document.getElementById('manageBackdrop');
            const content = document.getElementById('manageContent');
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            setTimeout(() => {
                backdrop.classList.remove('opacity-0');
                content.classList.remove('opacity-0', 'scale-95');
            }, 10);
            renderManageSubjects();
        }

        function closeManageModal() {
            const modal = document.getElementById('manageModal');
            const backdrop = document.getElementById('manageBackdrop');
            const content = document.getElementById('manageContent');
            backdrop.classList.add('opacity-0');
            content.classList.add('opacity-0', 'scale-95');
            setTimeout(() => {
                modal.classList.add('hidden');
                modal.classList.remove('flex');
            }, 250);
        }

        function renderManageSubjects() {
            const list = document.getElementById('manageSubjectsList');
            list.innerHTML = appData.subjects.map(sub => `
                <div class="bg-white dark:bg-white/5 p-4 rounded-2xl border border-gray-200 dark:border-white/10 shadow-sm group">
                    <div class="flex justify-between items-center mb-3">
                        <div class="font-bold text-slate-700 dark:text-slate-200">${sub.name}</div>
                        <div class="flex gap-2">
                            <button onclick="editSubject('${sub.id}')"
                                class="p-2 text-gray-400 hover:text-amber-500 hover:bg-amber-50 dark:hover:bg-amber-900/20 rounded-lg transition-colors"><i data-lucide="pencil" class="w-4 h-4"></i></button>
                            ${appData.subjects.length > 1 ? `<button onclick="deleteSubject('${sub.id}')"
                                class="p-2 text-gray-400 hover:text-rose-500 hover:bg-rose-50 dark:hover:bg-rose-900/20 rounded-lg transition-colors"><i data-lucide="trash-2" class="w-4 h-4"></i></button>` : ''}
                        </div>
                    </div>
                    <div class="space-y-2 pl-4 border-l-2 border-gray-100 dark:border-white/10">
                        ${sub.assignments.map(a => `
                            <div class="flex justify-between items-center text-sm group/assign">
                                <span class="text-gray-600 dark:text-gray-400">${a.title}: ${a.desc}</span>
                                <button onclick="deleteAssignment('${sub.id}', '${a.id}')"
                                    class="text-gray-300 hover:text-rose-500 opacity-0 group-hover/assign:opacity-100 transition-opacity"><i data-lucide="x" class="w-3 h-3"></i></button>
                            </div>
                        `).join('')}
                        <form onsubmit="handleAddAssignment(event, '${sub.id}')"
                            class="flex gap-2 mt-2 pt-2 border-t border-dashed border-gray-200 dark:border-white/10">
                            <input type="text" name="title" placeholder="งาน..."
                                class="w-1/3 p-2 text-xs border border-gray-200 dark:border-white/10 rounded-lg bg-gray-50 dark:bg-black/20 dark:text-white"
                                required>
                            <input type="text" name="desc" placeholder="รายละเอียด..."
                                class="flex-1 p-2 text-xs border border-gray-200 dark:border-white/10 rounded-lg bg-gray-50 dark:bg-black/20 dark:text-white"
                                required>
                            <button type="submit"
                                class="p-2 bg-gold-100 dark:bg-gold-900/20 text-gold-600 rounded-lg hover:bg-gold-200 dark:hover:bg-gold-900/40"><i data-lucide="plus" class="w-3 h-3"></i></button>
                        </form>
                    </div>
                </div>
            `).join('');
            lucide.createIcons();
        }

        function handleAddSubject(e) {
            e.preventDefault();
            const input = document.getElementById('newSubjectInput');
            const name = input.value.trim();
            if (!name) return;
            const newId = 'sub_' + Date.now();
            appData.subjects.push({ id: newId, name, assignments: [] });
            if (!appData.currentSubjectId) appData.currentSubjectId = newId;
            saveData();
            renderManageSubjects();
            renderTabs();
            input.value = '';
            showToast('เพิ่มวิชาแล้ว');
        }

        function deleteSubject(id) {
            showConfirmModal('ลบวิชา?', 'การลบวิชาจะลบงานทั้งหมดของวิชานี้ด้วย', () => {
                appData.subjects = appData.subjects.filter(s => s.id !== id);
                if (appData.currentSubjectId === id && appData.subjects.length) {
                    appData.currentSubjectId = appData.subjects[0].id;
                }
                saveData();
                renderManageSubjects();
                renderApp();
                showToast('ลบวิชาแล้ว', 'error');
            });
        }

        function editSubject(id) {
            const subject = appData.subjects.find(s => s.id === id);
            if (!subject) return;
            const newName = prompt('แก้ไขชื่อวิชา', subject.name);
            if (newName && newName.trim() !== '') {
                subject.name = newName.trim();
                saveData();
                renderApp();
                renderManageSubjects();
                showToast('อัปเดตชื่อวิชาแล้ว');
            }
        }

        function handleAddAssignment(e, subId) {
            e.preventDefault();
            const title = e.target.title.value.trim();
            const desc = e.target.desc.value.trim();
            const subject = appData.subjects.find(s => s.id === subId);
            if (subject && title && desc) {
                const newId = 'w' + Date.now();
                subject.assignments.push({ id: newId, title, desc });
                appData.students.forEach(s => s.missing.push(newId));
                saveData();
                renderManageSubjects();
                renderApp();
                e.target.reset();
            }
        }

        function deleteAssignment(subId, assignId) {
            const subject = appData.subjects.find(s => s.id === subId);
            if (!subject) return;
            showConfirmModal('ลบงาน?', 'งานนี้จะหายไปจากทุกนักเรียน', () => {
                subject.assignments = subject.assignments.filter(a => a.id !== assignId);
                appData.students.forEach(s => s.missing = s.missing.filter(m => m !== assignId));
                saveData();
                renderManageSubjects();
                renderApp();
                showToast('ลบงานแล้ว', 'error');
            });
        }

        function showToast(msg, type = 'success') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.innerHTML = `<div class="p-2 rounded-full ${type === 'success' ? 'bg-emerald-100 text-emerald-600' : 'bg-rose-100 text-rose-600'}"><i data-lucide="${type === 'success' ? 'check' : 'alert-circle'}" class="w-5 h-5"></i></div>
                <div class="font-bold text-slate-700 dark:text-slate-200 text-sm">${msg}</div>`;
            container.appendChild(toast);
            lucide.createIcons();
            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transform = 'translateX(100%)';
                setTimeout(() => toast.remove(), 300);
            }, 2500);
        }

        let confirmCallback = null;
        function showConfirmModal(title, msg, callback) {
            document.getElementById('confirmTitle').innerText = title;
            document.getElementById('confirmMessage').innerText = msg;
            confirmCallback = callback;
            const modal = document.getElementById('confirmModal');
            const backdrop = document.getElementById('confirmBackdrop');
            const content = document.getElementById('confirmContent');
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            setTimeout(() => {
                backdrop.classList.remove('opacity-0');
                content.classList.remove('opacity-0', 'scale-95');
            }, 10);
        }

        document.getElementById('confirmCancelBtn').addEventListener('click', () => {
            const modal = document.getElementById('confirmModal');
            const backdrop = document.getElementById('confirmBackdrop');
            const content = document.getElementById('confirmContent');
            backdrop.classList.add('opacity-0');
            content.classList.add('opacity-0', 'scale-95');
            setTimeout(() => {
                modal.classList.add('hidden');
                modal.classList.remove('flex');
            }, 200);
        });

        document.getElementById('confirmOkBtn').addEventListener('click', () => {
            if (confirmCallback) confirmCallback();
            document.getElementById('confirmCancelBtn').click();
        });

        renderApp();
    </script>
</body>

</html>
