<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Elite Tracker - รายชื่อนักเรียน</title>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Elite Tracker">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/3135/3135715.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                container: {
                    center: true,
                    padding: "2rem",
                    screens: {
                        "2xl": "1400px",
                    },
                },
                extend: {
                    fontFamily: { sans: ['Sarabun', 'sans-serif'], display: ['Outfit', 'sans-serif'] },
                    colors: {
                        border: "hsl(var(--border))",
                        input: "hsl(var(--input))",
                        ring: "hsl(var(--ring))",
                        background: "hsl(var(--background))",
                        foreground: "hsl(var(--foreground))",
                        primary: {
                            DEFAULT: "hsl(var(--primary))",
                            foreground: "hsl(var(--primary-foreground))",
                        },
                        secondary: {
                            DEFAULT: "hsl(var(--secondary))",
                            foreground: "hsl(var(--secondary-foreground))",
                        },
                        destructive: {
                            DEFAULT: "hsl(var(--destructive))",
                            foreground: "hsl(var(--destructive-foreground))",
                        },
                        muted: {
                            DEFAULT: "hsl(var(--muted))",
                            foreground: "hsl(var(--muted-foreground))",
                        },
                        accent: {
                            DEFAULT: "hsl(var(--accent))",
                            foreground: "hsl(var(--accent-foreground))",
                        },
                        popover: {
                            DEFAULT: "hsl(var(--popover))",
                            foreground: "hsl(var(--popover-foreground))",
                        },
                        card: {
                            DEFAULT: "hsl(var(--card))",
                            foreground: "hsl(var(--card-foreground))",
                        },
                        gold: { 50: '#fbf9f5', 100: '#f5efe0', 200: '#ebdcb8', 300: '#dfc385', 400: '#d4a855', 500: '#c6902d', 600: '#a67321', 700: '#85581e', 800: '#6e471e', 900: '#5b3b1c', 950: '#34200e' },
                        obsidian: { 800: '#18181b', 900: '#09090b', 950: '#020203' }
                    },
                    borderRadius: {
                        lg: "var(--radius)",
                        md: "calc(var(--radius) - 2px)",
                        sm: "calc(var(--radius) - 4px)",
                    },
                    boxShadow: {
                        glow: '0 0 20px rgba(184, 134, 28, 0.15)',
                        'glow-lg': '0 0 30px rgba(184, 134, 28, 0.25)'
                    }
                }
            }
        }
    </script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link
        href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&family=Outfit:wght@400;500;700&display=swap"
        rel="stylesheet">
    <style>
        :root {
            --background: 0 0% 100%;
            --foreground: 222.2 84% 4.9%;
            --card: 0 0% 100%;
            --card-foreground: 222.2 84% 4.9%;
            --popover: 0 0% 100%;
            --popover-foreground: 222.2 84% 4.9%;
            --primary: 43 74% 49%;
            --primary-foreground: 210 40% 98%;
            --secondary: 210 40% 96.1%;
            --secondary-foreground: 222.2 47.4% 11.2%;
            --muted: 210 40% 96.1%;
            --muted-foreground: 215.4 16.3% 46.9%;
            --accent: 210 40% 96.1%;
            --accent-foreground: 222.2 47.4% 11.2%;
            --destructive: 0 84.2% 60.2%;
            --destructive-foreground: 210 40% 98%;
            --border: 214.3 31.8% 91.4%;
            --input: 214.3 31.8% 91.4%;
            --ring: 43 74% 49%;
            --radius: 0.75rem;

            --glass-border: 255 255 255 / 0.4;
            --glass-bg: 255 255 255 / 0.65;
            --glass-shadow: 0 8px 32px rgba(0, 0, 0, 0.05);
        }

        .dark {
            --background: 240 10% 3.9%;
            --foreground: 210 40% 98%;
            --card: 240 10% 3.9%;
            --card-foreground: 210 40% 98%;
            --popover: 240 10% 3.9%;
            --popover-foreground: 210 40% 98%;
            --primary: 43 74% 49%;
            --primary-foreground: 210 40% 98%;
            --secondary: 217.2 32.6% 17.5%;
            --secondary-foreground: 210 40% 98%;
            --muted: 217.2 32.6% 17.5%;
            --muted-foreground: 215 20.2% 65.1%;
            --accent: 217.2 32.6% 17.5%;
            --accent-foreground: 210 40% 98%;
            --destructive: 0 62.8% 30.6%;
            --destructive-foreground: 210 40% 98%;
            --border: 217.2 32.6% 17.5%;
            --input: 217.2 32.6% 17.5%;
            --ring: 43 74% 49%;

            --glass-border: 255 255 255 / 0.08;
            --glass-bg: 10 10 12 / 0.6;
            --glass-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
        }

        /* Noise Texture */
        .bg-noise {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 50;
            opacity: 0.03;
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.65' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)' opacity='1'/%3E%3C/svg%3E");
        }

        .dark .bg-noise {
            opacity: 0.05;
        }

        body {
            font-family: 'Sarabun', sans-serif;
            overflow-x: hidden;
            line-height: 1.7;
        }

        /* Advanced Mesh Gradient */
        .mesh-bg {
            position: fixed;
            inset: 0;
            z-index: -1;
            background-color: hsl(var(--background));
            overflow: hidden;
        }

        .mesh-bg::before,
        .mesh-bg::after {
            content: '';
            position: absolute;
            width: 140vw;
            height: 140vw;
            top: -20%;
            left: -20%;
            border-radius: 50%;
            filter: blur(80px);
            opacity: 0.4;
            animation: blob 25s infinite alternate cubic-bezier(0.4, 0, 0.2, 1);
        }

        .mesh-bg::before {
            background: radial-gradient(circle, hsl(var(--primary) / 0.3) 0%, transparent 70%);
            animation-delay: -5s;
        }

        .mesh-bg::after {
            background: radial-gradient(circle, #8b5cf6 0%, transparent 70%);
            /* Purple accent */
            right: -20%;
            left: auto;
            top: auto;
            bottom: -20%;
            animation-delay: -12s;
            opacity: 0.2;
        }

        .dark .mesh-bg::before {
            background: radial-gradient(circle, hsl(var(--primary) / 0.15) 0%, transparent 60%);
        }

        .dark .mesh-bg::after {
            background: radial-gradient(circle, #581c87 0%, transparent 60%);
            opacity: 0.15;
        }

        @keyframes blob {
            0% {
                transform: translate(0, 0) scale(1) rotate(0deg);
            }

            33% {
                transform: translate(30px, -50px) scale(1.1) rotate(10deg);
            }

            66% {
                transform: translate(-20px, 20px) scale(0.9) rotate(-5deg);
            }

            100% {
                transform: translate(0, 0) scale(1) rotate(0deg);
            }
        }

        h1,
        h2,
        h3,
        .font-display {
            font-family: 'Outfit', sans-serif;
        }

        /* Advanced Glassmorphism */
        .glass-panel {
            background: var(--glass-bg);
            backdrop-filter: blur(24px) saturate(180%);
            -webkit-backdrop-filter: blur(24px) saturate(180%);
            border: 1px solid rgb(var(--glass-border));
            box-shadow: var(--glass-shadow), inset 0 0 0 1px rgba(255, 255, 255, 0.05);
        }

        /* Enhanced Cards */
        .bg-card {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.5);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
        }

        .dark .bg-card {
            background: rgba(20, 20, 25, 0.6);
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
        }



        /* Mesh Gradient Animation */
        .mesh-bg {
            position: fixed;
            inset: 0;
            z-index: -1;
            background-color: #f8fafc;
            background-image:
                radial-gradient(at 0% 0%, rgba(184, 134, 28, 0.15) 0px, transparent 50%),
                radial-gradient(at 100% 0%, rgba(99, 102, 241, 0.1) 0px, transparent 50%),
                radial-gradient(at 100% 100%, rgba(236, 72, 153, 0.1) 0px, transparent 50%),
                radial-gradient(at 0% 100%, rgba(34, 211, 238, 0.1) 0px, transparent 50%);
            animation: meshPulse 10s ease-in-out infinite alternate;
        }

        .dark .mesh-bg {
            background-color: #020203;
            background-image:
                radial-gradient(at 0% 0%, rgba(184, 134, 28, 0.15) 0px, transparent 50%),
                radial-gradient(at 100% 0%, rgba(79, 70, 229, 0.15) 0px, transparent 50%),
                radial-gradient(at 100% 100%, rgba(219, 39, 119, 0.1) 0px, transparent 50%),
                radial-gradient(at 0% 100%, rgba(14, 165, 233, 0.1) 0px, transparent 50%);
        }

        @keyframes meshPulse {
            0% {
                transform: scale(1);
            }

            100% {
                transform: scale(1.1);
            }
        }

        /* Animations */
        @keyframes fadeScale {
            from {
                opacity: 0;
                transform: scale(0.95) translateY(10px);
            }

            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        .animate-enter {
            animation: fadeScale 0.5s cubic-bezier(0.2, 0.8, 0.2, 1) forwards;
        }

        /* Smooth Accordion Animation */
        .accordion-wrapper {
            display: grid;
            grid-template-rows: 0fr;
            transition: grid-template-rows 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .accordion-wrapper.open {
            grid-template-rows: 1fr;
        }

        .accordion-inner {
            overflow: hidden;
        }

        .hover-float {
            transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        .hover-float:hover {
            transform: translateY(-4px);
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 10px;
        }

        .dark ::-webkit-scrollbar-thumb {
            background: #3f3f46;
        }

        /* Toast */
        #toast-container {
            position: fixed;
            bottom: 24px;
            right: 24px;
            z-index: 100;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .toast {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.5);
            padding: 16px 20px;
            border-radius: 16px;
            box-shadow: 0 10px 40px -10px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            gap: 12px;
            animation: slideInRight 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards;
            min-width: 300px;
        }

        .dark .toast {
            background: rgba(24, 24, 27, 0.9);
            border-color: rgba(255, 255, 255, 0.1);
            color: #f4f4f5;
            box-shadow: 0 10px 40px -10px rgba(0, 0, 0, 0.5);
        }

        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* Premium Button */
        .btn-premium {
            background-size: 200% auto;
            transition: 0.5s;
        }

        .btn-premium:hover {
            background-position: right center;
        }

        .btn-premium:active {
            transform: scale(0.96);
        }
    </style>
</head>

<body
    class="min-h-screen bg-background text-foreground font-sans antialiased selection:bg-primary selection:text-primary-foreground">
    <div class="mesh-bg"></div>
    <div class="bg-noise"></div>

    <div class="relative z-10 max-w-6xl mx-auto px-4 py-8 space-y-8">
        <header class="flex flex-col gap-6 sm:flex-row sm:items-center sm:justify-between animate-enter">
            <div class="relative">
                <div
                    class="absolute -inset-4 bg-gradient-to-r from-gold-400/20 to-purple-500/20 blur-xl rounded-full opacity-50 dark:opacity-30">
                </div>
                <div class="relative">
                    <div class="flex items-baseline gap-2 mb-2">
                        <span class="text-sm font-bold text-muted-foreground uppercase tracking-widest">Elite</span>
                        <span
                            class="text-3xl font-black text-transparent bg-clip-text bg-gradient-to-r from-gold-500 to-amber-600 uppercase tracking-widest font-display drop-shadow-sm">Tracker</span>
                    </div>
                    <h1 class="text-4xl sm:text-5xl font-display font-bold text-transparent bg-clip-text bg-gradient-to-r from-slate-900 via-slate-700 to-slate-900 dark:from-white dark:via-slate-200 dark:to-slate-400 drop-shadow-sm"
                        data-i18n="title">
                        รายการงานค้าง
                    </h1>
                </div>
            </div>
            <div class="flex items-center gap-4">
                <button onclick="toggleLanguage()"
                    class="inline-flex items-center justify-center rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 border border-input bg-background hover:bg-accent hover:text-accent-foreground h-10 w-10">
                    <span id="lang-display">TH</span>
                </button>
                <button id="themeToggle"
                    class="inline-flex items-center justify-center rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 border border-input bg-background hover:bg-accent hover:text-accent-foreground h-10 w-10 group">
                    <i data-lucide="moon" class="w-5 h-5 transition-all group-hover:rotate-12"></i>
                </button>
                <button onclick="openManageModal()"
                    class="inline-flex items-center justify-center rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 bg-primary text-primary-foreground hover:bg-primary/90 h-10 px-4 py-2 gap-2 shadow-lg shadow-primary/20">
                    <i data-lucide="settings-2" class="w-4 h-4"></i>
                    <span data-i18n="manage">จัดการวิชา</span>
                </button>
            </div>
        </header>

        <!-- Stats Dashboard -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 animate-enter" style="animation-delay: 0.05s;">
            <div
                class="rounded-xl border bg-card text-card-foreground shadow-sm p-6 flex items-center gap-4 hover-float">
                <div
                    class="w-12 h-12 rounded-full bg-blue-100 dark:bg-blue-900/20 flex items-center justify-center text-blue-600 dark:text-blue-400">
                    <i data-lucide="users" class="w-6 h-6"></i>
                </div>
                <div>
                    <div class="text-sm font-medium text-muted-foreground" data-i18n="totalStudents">
                        นักเรียนทั้งหมด</div>
                    <div class="text-2xl font-bold font-display" id="stat-total-students">0</div>
                </div>
            </div>
            <div
                class="rounded-xl border bg-card text-card-foreground shadow-sm p-6 flex items-center gap-4 hover-float">
                <div
                    class="w-12 h-12 rounded-full bg-emerald-100 dark:bg-emerald-900/20 flex items-center justify-center text-emerald-600 dark:text-emerald-400">
                    <i data-lucide="pie-chart" class="w-6 h-6"></i>
                </div>
                <div>
                    <div class="text-sm font-medium text-muted-foreground" data-i18n="completionRate">
                        ความสำเร็จรวม</div>
                    <div class="text-2xl font-bold font-display" id="stat-completion-rate">0%</div>
                </div>
            </div>
            <div
                class="rounded-xl border bg-card text-card-foreground shadow-sm p-6 flex items-center gap-4 hover-float">
                <div
                    class="w-12 h-12 rounded-full bg-amber-100 dark:bg-amber-900/20 flex items-center justify-center text-amber-600 dark:text-amber-400">
                    <i data-lucide="alert-circle" class="w-6 h-6"></i>
                </div>
                <div>
                    <div class="text-sm font-medium text-muted-foreground" data-i18n="pendingTasks">
                        งานที่ค้างอยู่</div>
                    <div class="text-2xl font-bold font-display" id="stat-pending-tasks">
                        0</div>
                </div>
            </div>
        </div>

        <section class="rounded-xl border bg-card text-card-foreground shadow-sm p-6 sm:p-8 animate-enter"
            style="animation-delay: 0.1s;">
            <div class="flex flex-col xl:flex-row xl:items-center justify-between gap-6 mb-8">
                <div class="space-y-2">
                    <div class="text-xs uppercase text-muted-foreground font-semibold tracking-[0.2em]"
                        data-i18n="selectedSubject">วิชา</div>
                    <div id="subjectTabs" class="flex flex-wrap gap-2"></div>
                </div>
                <form id="addStudentForm" class="flex flex-col sm:flex-row gap-3 w-full sm:w-auto">
                    <input id="studentName" name="studentName" type="text" placeholder="เพิ่มชื่อนักเรียน"
                        class="flex h-10 w-full sm:w-64 rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background file:border-0 file:bg-transparent file:text-sm file:font-medium placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50"
                        required>
                    <button type="submit"
                        class="inline-flex items-center justify-center rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 bg-primary text-primary-foreground hover:bg-primary/90 h-10 px-4 py-2"
                        data-i18n="addStudentBtn">
                        เพิ่มนักเรียน
                    </button>
                </form>
            </div>

            <div class="mt-6 space-y-4">
                <div class="lg:hidden">
                    <div class="flex items-center justify-between mb-2">
                        <h2 class="text-lg font-semibold text-slate-800 dark:text-white" data-i18n="studentListMobile">
                            รายชื่อนักเรียน (แตะเพื่อขยาย)
                        </h2>
                        <span
                            class="text-xs px-2 py-1 rounded-full bg-amber-100 text-amber-700 dark:bg-amber-900/30 dark:text-amber-200"
                            data-i18n="mobileLabel">โมบาย</span>
                    </div>
                    <div id="mobileCards" class="space-y-3"></div>
                </div>

                <div class="hidden lg:block">
                    <div class="flex items-center justify-between mb-3">
                        <h2 class="text-lg font-semibold" data-i18n="studentListDesktop">
                            รายชื่อนักเรียน</h2>
                        <span class="text-xs px-2 py-1 rounded-full bg-secondary text-secondary-foreground"
                            data-i18n="desktopLabel">เดสก์ท็อป</span>
                    </div>
                    <div class="overflow-hidden rounded-xl border bg-card text-card-foreground shadow-sm">
                        <table class="min-w-full text-sm">
                            <thead class="bg-muted/50 text-muted-foreground">
                                <tr>
                                    <th class="text-left px-6 py-3 font-medium" data-i18n="colName">ชื่อ</th>
                                    <th class="text-left px-6 py-3 font-medium" data-i18n="colStatus">สถานะ</th>
                                    <th class="text-left px-6 py-3 font-medium" data-i18n="colMissing">งานค้าง</th>
                                    <th class="text-right px-6 py-3 font-medium" data-i18n="colManage">จัดการ</th>
                                </tr>
                            </thead>
                            <tbody id="studentTableBody" class="divide-y divide-border"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </section>
    </div>

    <div id="manageModal" class="fixed inset-0 hidden items-center justify-center z-30">
        <div id="manageBackdrop" class="absolute inset-0 bg-background/80 backdrop-blur-sm opacity-0 transition"></div>
        <div id="manageContent"
            class="relative max-w-3xl w-full mx-4 bg-card rounded-xl shadow-lg border border-border overflow-hidden opacity-0 scale-95 transition">
            <div class="p-6 border-b border-border flex justify-between items-center">
                <div>
                    <h2 class="text-2xl font-display font-bold" data-i18n="manageModalTitle">จัดการวิชาและงาน</h2>
                    <p class="text-sm text-muted-foreground" data-i18n="manageModalDesc">
                        เพิ่มวิชาและรายการงานที่ต้องตรวจสอบ</p>
                </div>
                <button onclick="closeManageModal()"
                    class="rounded-sm opacity-70 ring-offset-background transition-opacity hover:opacity-100 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none data-[state=open]:bg-accent data-[state=open]:text-muted-foreground"><i
                        data-lucide="x" class="w-4 h-4"></i></button>
            </div>
            <div class="p-6 space-y-4 max-h-[70vh] overflow-y-auto" id="manageSubjectsList"></div>
            <div class="p-6 border-t border-border bg-muted/30">
                <form onsubmit="handleAddSubject(event)" class="flex gap-3">
                    <input id="newSubjectInput" type="text" placeholder="ชื่อวิชาใหม่"
                        class="flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background file:border-0 file:bg-transparent file:text-sm file:font-medium placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 flex-1"
                        required>
                    <button type="submit"
                        class="inline-flex items-center justify-center rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 bg-primary text-primary-foreground hover:bg-primary/90 h-10 px-4 py-2"
                        data-i18n="addSubjectBtn">เพิ่มวิชา</button>
                </form>
            </div>
        </div>
    </div>

    <div id="studentDetailModal" class="fixed inset-0 hidden items-center justify-center z-40">
        <div id="detailBackdrop" class="absolute inset-0 bg-background/80 backdrop-blur-sm opacity-0 transition"></div>
        <div id="detailContent"
            class="relative max-w-xl w-full mx-4 bg-card rounded-xl shadow-lg border border-border overflow-hidden opacity-0 scale-95 transition">
            <div id="studentDetailBody" class="flex flex-col max-h-[80vh]"></div>
        </div>
    </div>

    <div id="confirmModal" class="fixed inset-0 hidden items-center justify-center z-50">
        <div id="confirmBackdrop" class="absolute inset-0 bg-background/80 backdrop-blur-sm opacity-0 transition"></div>
        <div id="confirmContent"
            class="relative w-full max-w-sm mx-4 bg-card rounded-xl shadow-lg border border-border p-6 opacity-0 scale-95 transition">
            <div class="flex items-start gap-3">
                <div class="p-2 rounded-full bg-amber-100 text-amber-600 dark:bg-amber-900/30"><i
                        data-lucide="alert-circle" class="w-5 h-5"></i></div>
                <div class="flex-1">
                    <h3 id="confirmTitle" class="text-lg font-semibold"></h3>
                    <p id="confirmMessage" class="text-sm text-muted-foreground mt-1"></p>
                </div>
            </div>
            <div class="mt-6 flex justify-end gap-2">
                <button id="confirmCancelBtn"
                    class="inline-flex items-center justify-center rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 border border-input bg-background hover:bg-accent hover:text-accent-foreground h-10 px-4 py-2"
                    data-i18n="cancel">ยกเลิก</button>
                <button id="confirmOkBtn"
                    class="inline-flex items-center justify-center rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 bg-destructive text-destructive-foreground hover:bg-destructive/90 h-10 px-4 py-2"
                    data-i18n="confirmAction">ดำเนินการ</button>
            </div>
        </div>
    </div>

    <div id="editStudentModal" class="fixed inset-0 hidden items-center justify-center z-40">
        <div id="editStudentBackdrop" class="absolute inset-0 bg-background/80 backdrop-blur-sm opacity-0 transition">
        </div>
        <div id="editStudentContent"
            class="relative w-full max-w-md mx-4 bg-card rounded-xl shadow-lg border border-border overflow-hidden opacity-0 scale-95 transition">
            <div class="p-6 border-b border-border flex justify-between items-center">
                <h2 class="text-xl font-bold font-display" data-i18n="editStudentTitle">Edit Student</h2>
                <button onclick="closeEditStudentModal()"
                    class="rounded-sm opacity-70 ring-offset-background transition-opacity hover:opacity-100 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none data-[state=open]:bg-accent data-[state=open]:text-muted-foreground"><i
                        data-lucide="x" class="w-4 h-4"></i></button>
            </div>
            <div class="p-6 space-y-4">
                <input type="hidden" id="editStudentId">
                <div class="space-y-2">
                    <label
                        class="text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70"
                        data-i18n="studentName">Student Name</label>
                    <input id="editStudentName" type="text"
                        class="flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background file:border-0 file:bg-transparent file:text-sm file:font-medium placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50">
                </div>
                <div class="space-y-2">
                    <label
                        class="text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70"
                        data-i18n="studentNote">Note</label>
                    <textarea id="editStudentNote" rows="3"
                        class="flex min-h-[80px] w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50"></textarea>
                </div>
            </div>
            <div class="p-6 border-t border-border bg-muted/30 flex justify-end gap-2">
                <button onclick="closeEditStudentModal()"
                    class="inline-flex items-center justify-center rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 border border-input bg-background hover:bg-accent hover:text-accent-foreground h-10 px-4 py-2"
                    data-i18n="cancel">Cancel</button>
                <button onclick="saveStudentDetails()"
                    class="inline-flex items-center justify-center rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 bg-primary text-primary-foreground hover:bg-primary/90 h-10 px-4 py-2"
                    data-i18n="saveChanges">Save Changes</button>
            </div>
        </div>
    </div>

    <div id="toast-container"></div>

    <script>
        const translations = {
            th: {
                title: "รายการงานค้าง",
                subtitle: "Elite Tracker",
                manage: "จัดการวิชา",
                totalStudents: "นักเรียนทั้งหมด",
                completionRate: "ความสำเร็จรวม",
                pendingTasks: "งานที่ค้างอยู่",
                selectedSubject: "วิชาที่เลือก",
                addStudentPlaceholder: "ชื่อนักเรียนใหม่...",
                addStudentBtn: "เพิ่มนักเรียน",
                studentListMobile: "รายชื่อนักเรียน (แตะเพื่อขยาย)",
                mobileLabel: "โมบาย",
                studentListDesktop: "รายชื่อนักเรียน",
                desktopLabel: "เดสก์ท็อป",
                colName: "ชื่อ",
                colStatus: "สถานะ",
                colMissing: "งานค้าง",
                colManage: "จัดการ",
                manageModalTitle: "จัดการวิชาและงาน",
                manageModalDesc: "เพิ่มวิชาและรายการงานที่ต้องตรวจสอบ",
                addSubjectBtn: "เพิ่มวิชา",
                confirmAction: "ดำเนินการ",
                noSubjects: "โปรดเพิ่มวิชาอย่างน้อย 1 วิชา",
                noData: "ยังไม่มีข้อมูลวิชา",
                noWork: "ไม่มีงาน",
                complete: "ครบแล้ว",
                pending: "งานค้าง",
                tapToView: "แตะเพื่อดูงานที่ค้าง",
                tapToDetail: "แตะเพื่อดูรายละเอียด",
                markAll: "ทำเครื่องหมายว่าเสร็จทั้งหมด",
                editName: "แก้ไขชื่อ",
                delete: "ลบ",
                confirmDelete: "คุณแน่ใจหรือไม่ที่จะลบ",
                studentName: "ชื่อนักเรียน",
                save: "บันทึก",
                cancel: "ยกเลิก",
                manageSubjects: "จัดการวิชา",
                addSubjectPlaceholder: "ชื่อวิชาใหม่...",
                assignments: "งานที่มอบหมาย",
                addAssignmentPlaceholder: "ชื่องาน...",
                descPlaceholder: "รายละเอียด...",
                close: "ปิด",
                studentAdded: "เพิ่มนักเรียนแล้ว",
                allComplete: "ทำงานครบทั้งหมดแล้ว",
                deleteStudent: "ลบนักเรียน?",
                deleteIrreversible: "การลบนี้ไม่สามารถย้อนกลับได้",
                studentDeleted: "ลบนักเรียนแล้ว",
                editStudentName: "แก้ไขชื่อนักเรียน",
                nameUpdated: "อัปเดตชื่อแล้ว",
                completeLabel: "เสร็จสิ้น",
                subjectAdded: "เพิ่มวิชาแล้ว",
                deleteSubjectTitle: "ลบวิชา?",
                deleteSubjectMsg: "การลบวิชาจะลบงานทั้งหมดของวิชานี้ด้วย",
                subjectDeleted: "ลบวิชาแล้ว",
                editSubjectTitle: "แก้ไขชื่อวิชา",
                subjectUpdated: "อัปเดตชื่อวิชาแล้ว",
                deleteAssignmentTitle: "ลบงาน?",
                deleteAssignmentMsg: "งานนี้จะหายไปจากทุกนักเรียน",
                assignmentDeleted: "ลบงานแล้ว",
                editStudentTitle: "แก้ไขข้อมูลนักเรียน",
                studentNote: "บันทึกข้อความ",
                notePlaceholder: "เพิ่มบันทึกเกี่ยวกับนักเรียนคนนี้...",
                saveChanges: "บันทึกการเปลี่ยนแปลง",
                assignmentAdded: "เพิ่มงานแล้ว"
            },
            en: {
                title: "Pending Tasks",
                subtitle: "Elite Tracker",
                manage: "Manage Subjects",
                totalStudents: "Total Students",
                completionRate: "Completion Rate",
                pendingTasks: "Pending Tasks",
                selectedSubject: "Selected Subject",
                addStudentPlaceholder: "New Student Name...",
                addStudentBtn: "Add Student",
                studentListMobile: "Student List (Tap to Expand)",
                mobileLabel: "Mobile",
                studentListDesktop: "Student List",
                desktopLabel: "Desktop",
                colName: "Name",
                colStatus: "Status",
                colMissing: "Missing",
                colManage: "Manage",
                manageModalTitle: "Manage Subjects & Tasks",
                manageModalDesc: "Add subjects and tasks to track.",
                addSubjectBtn: "Add Subject",
                confirmAction: "Confirm",
                noSubjects: "Please add at least 1 subject",
                noData: "No subject data available",
                noWork: "No Work",
                complete: "Complete",
                pending: "Pending",
                tapToView: "Tap to view pending tasks",
                tapToDetail: "Tap for details",
                markAll: "Mark All Complete",
                editName: "Edit Name",
                delete: "Delete",
                confirmDelete: "Are you sure you want to delete",
                studentName: "Student Name",
                save: "Save",
                cancel: "Cancel",
                manageSubjects: "Manage Subjects",
                addSubjectPlaceholder: "New Subject Name...",
                assignments: "Assignments",
                addAssignmentPlaceholder: "Assignment Title...",
                descPlaceholder: "Description...",
                close: "Close",
                studentAdded: "Student added",
                allComplete: "All tasks completed",
                deleteStudent: "Delete Student?",
                deleteIrreversible: "This action cannot be undone",
                studentDeleted: "Student deleted",
                editStudentName: "Edit Student Name",
                nameUpdated: "Name updated",
                completeLabel: "Complete",
                subjectAdded: "Subject added",
                deleteSubjectTitle: "Delete Subject?",
                deleteSubjectMsg: "Deleting this subject will remove all its tasks.",
                subjectDeleted: "Subject deleted",
                editSubjectTitle: "Edit Subject Name",
                subjectUpdated: "Subject name updated",
                deleteAssignmentTitle: "Delete Task?",
                deleteAssignmentMsg: "This task will be removed from all students.",
                assignmentDeleted: "Task deleted",
                editStudentTitle: "Edit Student",
                studentNote: "Note",
                notePlaceholder: "Add a note about this student...",
                saveChanges: "Save Changes",
                assignmentAdded: "Task added"
            }
        };

        let currentLang = localStorage.getItem('elite-lang') || 'th';

        function toggleLanguage() {
            currentLang = currentLang === 'th' ? 'en' : 'th';
            localStorage.setItem('elite-lang', currentLang);
            updateLanguage();
            renderApp();
        }

        function updateLanguage() {
            const t = translations[currentLang];
            document.getElementById('lang-display').innerText = currentLang.toUpperCase();

            // Update all elements with data-i18n
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                if (t[key]) el.innerText = t[key];
            });

            // Update placeholders
            const studentInput = document.querySelector('#addStudentForm input');
            if (studentInput) studentInput.placeholder = t.addStudentPlaceholder;
            const subjectInput = document.querySelector('#newSubjectInput');
            if (subjectInput) subjectInput.placeholder = t.addSubjectPlaceholder;
        }

        // Initialize Language
        document.addEventListener('DOMContentLoaded', () => {
            updateLanguage();
        });

        const STORAGE_KEY = 'elite-tracker-data';
        const defaultData = {
            subjects: [
                {
                    id: 'sub_default',
                    name: 'คณิตศาสตร์',
                    assignments: [
                        { id: 'a1', title: 'ใบงาน 1', desc: 'แบบฝึกหัดเศษส่วน' },
                        { id: 'a2', title: 'ใบงาน 2', desc: 'โจทย์สมการพื้นฐาน' },
                        { id: 'a3', title: 'แบบฝึกหัดเสริม', desc: 'การบ้านทบทวน' }
                    ]
                }
            ],
            students: [
                { id: 1, name: 'นาย ก', missing: ['a1', 'a3'], note: '' },
                { id: 2, name: 'นาง ข', missing: ['a2'], note: 'ต้องติดตามงานใกล้ชิด' },
                { id: 3, name: 'นาย ค', missing: [], note: '' }
            ],
            currentSubjectId: 'sub_default',
            settings: { theme: 'light' }
        };

        let appData = loadData();
        applyTheme(appData.settings?.theme || 'light');

        const addStudentForm = document.getElementById('addStudentForm');
        addStudentForm.addEventListener('submit', handleAddStudent);

        document.getElementById('themeToggle').addEventListener('click', () => {
            const newTheme = document.documentElement.classList.contains('dark') ? 'light' : 'dark';
            applyTheme(newTheme);
            appData.settings.theme = newTheme;
            saveData();
        });

        function loadData() {
            const saved = localStorage.getItem(STORAGE_KEY);
            if (!saved) return structuredClone(defaultData);
            try {
                const parsed = JSON.parse(saved);
                return { ...structuredClone(defaultData), ...parsed };
            } catch (e) {
                console.warn('Cannot parse saved data, using default.', e);
                return structuredClone(defaultData);
            }
        }

        function saveData() {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(appData));
        }

        function applyTheme(mode) {
            if (mode === 'dark') {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
            const themeBtnIcon = document.getElementById('themeToggle').querySelector('i');
            themeBtnIcon.setAttribute('data-lucide', mode === 'dark' ? 'sun' : 'moon');
            lucide.createIcons();
        }

        function currentSubject() {
            return appData.subjects.find(s => s.id === appData.currentSubjectId) || appData.subjects[0];
        }

        function renderTabs() {
            const t = translations[currentLang];
            const tabs = document.getElementById('subjectTabs');
            if (!appData.subjects.length) {
                tabs.innerHTML = `<div class="text-sm text-rose-500 font-medium bg-rose-50 dark:bg-rose-900/20 px-4 py-2 rounded-xl">${t.noSubjects}</div>`;
                return;
            }
            tabs.innerHTML = appData.subjects.map(sub => {
                const isActive = sub.id === currentSubject().id;
                return `
                    <button onclick="switchSubject('${sub.id}')"
                        class="px-5 py-2.5 rounded-full text-sm font-bold transition-all duration-300 ${isActive
                        ? 'bg-gradient-to-r from-slate-800 to-slate-900 dark:from-white dark:to-slate-200 text-white dark:text-slate-900 shadow-lg shadow-slate-500/30 dark:shadow-white/20 scale-105'
                        : 'bg-white/50 dark:bg-white/5 text-slate-600 dark:text-slate-400 hover:bg-white dark:hover:bg-white/10 hover:scale-105'}">
                        ${sub.name}
                        <span class="ml-2 text-xs opacity-80 bg-white/20 px-1.5 py-0.5 rounded-full">${sub.assignments.length}</span>
                    </button>
                `;
            }).join('');
        }

        function renderMobileCards() {
            const t = translations[currentLang];
            const container = document.getElementById('mobileCards');
            const subject = currentSubject();
            if (!subject) {
                container.innerHTML = `<div class="text-sm text-destructive text-center py-8">${t.noData}</div>`;
                return;
            }

            container.innerHTML = appData.students.map((student, index) => {
                const missing = subject.assignments.filter(a => student.missing.includes(a.id));
                const missingCount = missing.length;
                const total = subject.assignments.length || 0;
                const statusText = total === 0 ? t.noWork : missingCount === 0 ? t.complete : `${missingCount} ${t.pending}`;
                const statusClass = missingCount === 0
                    ? 'bg-emerald-500 text-white shadow-emerald-500/30'
                    : 'bg-amber-500 text-white shadow-amber-500/30';

                return `
                    <div class="rounded-xl border bg-card text-card-foreground shadow-sm overflow-hidden hover-float animate-enter" style="animation-delay: ${index * 0.05}s">
                        <button type="button" onclick="toggleCard(${student.id})"
                            class="w-full flex items-center justify-between px-5 py-4 bg-card hover:bg-accent/50 transition-colors">
                            <div class="flex items-center gap-4">
                                <div class="w-10 h-10 rounded-full bg-muted flex items-center justify-center text-muted-foreground font-bold text-sm">
                                    ${student.name.charAt(0)}
                                </div>
                                <div class="text-left">
                                    <div class="font-bold text-lg leading-tight">${student.name}</div>
                                    <div class="text-xs text-muted-foreground mt-0.5 font-medium">ID: ${student.id}</div>
                                </div>
                            </div>
                            <div class="flex items-center gap-3">
                                <span class="text-xs px-3 py-1.5 rounded-full font-bold shadow-sm ${statusClass}">${statusText}</span>
                                <div class="w-8 h-8 rounded-full bg-muted flex items-center justify-center">
                                    <i id="chevron-${student.id}" data-lucide="chevron-down" class="w-4 h-4 text-muted-foreground transition-transform duration-300"></i>
                                </div>
                            </div>
                        </button>
                        <div id="card-content-${student.id}" class="accordion-wrapper border-t bg-muted/30">
                            <div class="accordion-inner p-4 grid grid-cols-1 gap-3">
                                ${subject.assignments.map(a => `
                                    <label class="flex items-center gap-4 p-3 rounded-xl border transition-all duration-200 cursor-pointer group ${student.missing.includes(a.id)
                        ? 'border-border bg-card hover:bg-accent'
                        : 'border-emerald-200/50 bg-emerald-50/50 dark:bg-emerald-900/20 dark:border-emerald-500/20'}">
                                        <div class="relative flex items-center justify-center">
                                            <input type="checkbox" ${student.missing.includes(a.id) ? '' : 'checked'}
                                                onchange="toggleMissing(${student.id}, '${a.id}')"
                                                class="peer appearance-none w-5 h-5 rounded border border-primary text-primary shadow-sm focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:cursor-not-allowed disabled:opacity-50 checked:bg-primary checked:border-primary transition-colors cursor-pointer">
                                            <i data-lucide="check" class="w-3.5 h-3.5 text-primary-foreground absolute opacity-0 peer-checked:opacity-100 transition-opacity pointer-events-none"></i>
                                        </div>
                                        <div class="flex-1">
                                            <div class="font-medium text-sm group-hover:text-primary transition-colors">${a.title}</div>
                                            <div class="text-xs text-muted-foreground">${a.desc}</div>
                                        </div>
                                    </label>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            lucide.createIcons();
        }

        function renderTable() {
            const t = translations[currentLang];
            const tbody = document.getElementById('studentTableBody');
            const subject = currentSubject();
            if (!subject) {
                tbody.innerHTML = '';
                return;
            }
            tbody.innerHTML = appData.students.map((student, index) => {
                const missingCount = subject.assignments.filter(a => student.missing.includes(a.id)).length;
                const total = subject.assignments.length || 0;
                const progress = total === 0 ? 0 : Math.round(((total - missingCount) / total) * 100);
                return `
                    <tr class="hover:bg-muted/50 transition-colors duration-200 animate-enter" style="animation-delay: ${index * 0.03}s">
                        <td class="px-6 py-4">
                            <div class="flex items-center gap-3">
                                <div class="w-8 h-8 rounded-full bg-muted flex items-center justify-center text-muted-foreground font-bold text-xs">
                                    ${student.name.charAt(0)}
                                </div>
                                <div>
                                    <button class="text-left font-bold hover:text-primary transition-colors"
                                        onclick="openStudentModal(${student.id})">${student.name}</button>
                                    <div class="text-[10px] text-muted-foreground font-medium">ID: ${student.id}</div>
                                </div>
                            </div>
                        </td>
                        <td class="px-6 py-4">
                            <div class="flex items-center gap-3">
                                <div class="w-24 h-2 bg-secondary rounded-full overflow-hidden">
                                    <div class="h-full rounded-full ${progress === 100 ? 'bg-emerald-500' : 'bg-primary'}" style="width:${progress}%"></div>
                                </div>
                                <span class="text-xs font-bold text-muted-foreground">${progress}%</span>
                            </div>
                        </td>
                        <td class="px-6 py-4">
                            <span class="px-3 py-1 text-xs font-bold rounded-full shadow-sm ${missingCount === 0
                        ? 'bg-emerald-100 text-emerald-700 dark:bg-emerald-500/20 dark:text-emerald-300'
                        : 'bg-amber-100 text-amber-700 dark:bg-amber-500/20 dark:text-amber-300'}">
                                ${missingCount === 0 ? t.complete : `${missingCount} ${t.pending}`}
                            </span>
                        </td>
                        <td class="px-6 py-4 text-right">
                            <div class="flex items-center justify-end gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
                                <button title="${t.markAll}" onclick="markAllComplete(${student.id})"
                                    class="inline-flex items-center justify-center rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 border border-input bg-background hover:bg-accent hover:text-accent-foreground h-8 w-8"><i data-lucide="check-circle" class="w-4 h-4"></i></button>
                                <button title="${t.editName}" onclick="editStudent(${student.id})"
                                    class="inline-flex items-center justify-center rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 border border-input bg-background hover:bg-accent hover:text-accent-foreground h-8 w-8"><i data-lucide="pencil" class="w-4 h-4"></i></button>
                                <button title="${t.delete}" onclick="removeStudent(${student.id})"
                                    class="inline-flex items-center justify-center rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 border border-input bg-background hover:bg-destructive hover:text-destructive-foreground h-8 w-8"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
            lucide.createIcons();
        }

        function renderStats() {
            const subject = currentSubject();
            if (!subject) return;

            const totalStudents = appData.students.length;
            const totalAssignments = subject.assignments.length * totalStudents;

            let totalMissing = 0;
            appData.students.forEach(s => {
                const missingForSubject = s.missing.filter(m => subject.assignments.some(a => a.id === m)).length;
                totalMissing += missingForSubject;
            });

            const totalCompleted = totalAssignments - totalMissing;
            const completionRate = totalAssignments === 0 ? 0 : Math.round((totalCompleted / totalAssignments) * 100);

            // Animate numbers
            animateValue("stat-total-students", parseInt(document.getElementById("stat-total-students").innerText), totalStudents, 500);
            animateValue("stat-completion-rate", parseInt(document.getElementById("stat-completion-rate").innerText), completionRate, 500, "%");
            animateValue("stat-pending-tasks", parseInt(document.getElementById("stat-pending-tasks").innerText), totalMissing, 500);
        }

        function animateValue(id, start, end, duration, suffix = "") {
            if (start === end) return;
            const range = end - start;
            let current = start;
            const increment = end > start ? 1 : -1;
            const stepTime = Math.abs(Math.floor(duration / range));
            const obj = document.getElementById(id);

            const timer = setInterval(function () {
                current += increment;
                obj.innerHTML = current + suffix;
                if (current == end) {
                    clearInterval(timer);
                }
            }, stepTime);
        }

        function renderApp() {
            renderTabs();
            renderMobileCards();
            renderTable();
            renderStats();
        }

        function switchSubject(id) {
            appData.currentSubjectId = id;
            saveData();
            renderApp();
        }

        function handleAddStudent(e) {
            e.preventDefault();
            const t = translations[currentLang];
            const input = document.getElementById('studentName');
            const name = input.value.trim();
            if (!name) return;
            const newId = Date.now();
            const subjectAssignments = currentSubject()?.assignments || [];
            const missing = subjectAssignments.map(a => a.id);
            appData.students.push({ id: newId, name, missing, note: '' });
            saveData();
            renderApp();
            input.value = '';
            showToast(t.studentAdded);
        }

        function toggleMissing(studentId, assignmentId) {
            const student = appData.students.find(s => s.id === studentId);
            if (!student) return;
            if (student.missing.includes(assignmentId)) {
                student.missing = student.missing.filter(m => m !== assignmentId);
            } else {
                student.missing.push(assignmentId);
            }
            saveData();
            renderApp();
        }

        function markAllComplete(studentId) {
            const t = translations[currentLang];
            const subject = currentSubject();
            const student = appData.students.find(s => s.id === studentId);
            if (!student || !subject) return;
            subject.assignments.forEach(a => {
                student.missing = student.missing.filter(m => m !== a.id);
            });
            saveData();
            renderApp();
            showToast(t.allComplete);
        }

        function removeStudent(id) {
            const t = translations[currentLang];
            showConfirmModal(t.deleteStudent, t.deleteIrreversible, () => {
                appData.students = appData.students.filter(s => s.id !== id);
                saveData();
                renderApp();
                showToast(t.studentDeleted, 'error');
            });
        }

        function editStudent(id) {
            const t = translations[currentLang];
            const student = appData.students.find(s => s.id === id);
            if (!student) return;

            document.getElementById('editStudentId').value = student.id;
            document.getElementById('editStudentName').value = student.name;
            document.getElementById('editStudentNote').value = student.note || '';
            document.getElementById('editStudentNote').placeholder = t.notePlaceholder;

            const modal = document.getElementById('editStudentModal');
            const backdrop = document.getElementById('editStudentBackdrop');
            const content = document.getElementById('editStudentContent');

            modal.classList.remove('hidden');
            modal.classList.add('flex');
            setTimeout(() => {
                backdrop.classList.remove('opacity-0');
                content.classList.remove('opacity-0', 'scale-95');
            }, 10);
        }

        function closeEditStudentModal() {
            const modal = document.getElementById('editStudentModal');
            const backdrop = document.getElementById('editStudentBackdrop');
            const content = document.getElementById('editStudentContent');

            backdrop.classList.add('opacity-0');
            content.classList.add('opacity-0', 'scale-95');
            setTimeout(() => {
                modal.classList.add('hidden');
                modal.classList.remove('flex');
            }, 250);
        }

        function saveStudentDetails() {
            const t = translations[currentLang];
            const id = parseInt(document.getElementById('editStudentId').value);
            const name = document.getElementById('editStudentName').value.trim();
            const note = document.getElementById('editStudentNote').value.trim();

            const student = appData.students.find(s => s.id === id);
            if (!student || !name) return;

            student.name = name;
            student.note = note;

            saveData();
            renderApp();
            closeEditStudentModal();
            showToast(t.nameUpdated);
        }

        function toggleCard(id) {
            const content = document.getElementById(`card-content-${id}`);
            const chevron = document.getElementById(`chevron-${id}`);
            if (!content || !chevron) return;
            content.classList.toggle('open');
            const isOpen = content.classList.contains('open');
            chevron.style.transform = isOpen ? 'rotate(180deg)' : 'rotate(0deg)';
        }

        function openStudentModal(id) {
            const t = translations[currentLang];
            const student = appData.students.find(s => s.id === id);
            const subject = currentSubject();
            if (!student || !subject) return;

            const modal = document.getElementById('studentDetailModal');
            const backdrop = document.getElementById('detailBackdrop');
            const content = document.getElementById('detailContent');
            const body = document.getElementById('studentDetailBody');

            const total = subject.assignments.length;
            const missingCount = subject.assignments.filter(a => student.missing.includes(a.id)).length;
            const completedCount = total - missingCount;
            const progress = total === 0 ? 0 : Math.round((completedCount / total) * 100);
            const dashArray = `${progress}, 100`;

            body.innerHTML = `
                <div class="p-6 border-b border-border flex justify-between items-center bg-muted/30">
                    <div>
                        <h2 class="text-2xl font-bold font-display">${student.name}</h2>
                        <p class="text-sm text-muted-foreground">ID: ${student.id}</p>
                        ${student.note ? `<div class="mt-2 text-sm bg-amber-50 dark:bg-amber-900/20 text-amber-700 dark:text-amber-300 p-2 rounded-md border border-amber-200 dark:border-amber-800/30 flex gap-2 items-start">
                            <i data-lucide="sticky-note" class="w-4 h-4 mt-0.5 shrink-0"></i>
                            <span>${student.note}</span>
                        </div>` : ''}
                    </div>
                    <button onclick="closeStudentModal()"
                        class="rounded-sm opacity-70 ring-offset-background transition-opacity hover:opacity-100 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none data-[state=open]:bg-accent data-[state=open]:text-muted-foreground"><i data-lucide="x" class="w-4 h-4"></i></button>
                </div>
                <div class="p-6 overflow-y-auto flex-1 bg-card space-y-6">
                    <div class="flex items-center justify-center">
                        <div class="relative w-32 h-32">
                            <svg viewBox="0 0 36 36" class="circular-chart">
                                <path class="circle-bg"
                                    d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" />
                                <path class="circle" stroke="${progress >= 80 ? '#10b981' : (progress >= 50 ? '#f59e0b' : '#f43f5e')}"
                                    stroke-dasharray="${dashArray}"
                                    d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" />
                            </svg>
                            <div class="absolute inset-0 flex items-center justify-center flex-col">
                                <span class="text-2xl font-bold">${progress}%</span>
                                <span class="text-[10px] uppercase tracking-wider text-muted-foreground">${t.completeLabel}</span>
                            </div>
                        </div>
                    </div>
                    <div class="space-y-3">
                        ${subject.assignments.map(a => `
                            <div onclick="toggleMissing(${student.id}, '${a.id}'); openStudentModal(${student.id})"
                                class="cursor-pointer p-4 rounded-xl border transition-all flex items-center justify-between group ${!student.missing.includes(a.id)
                    ? 'bg-emerald-50 dark:bg-emerald-900/10 border-emerald-200 dark:border-emerald-900/30'
                    : 'bg-card border-border hover:border-primary/50'}">
                                <div>
                                    <div class="font-bold text-sm ${!student.missing.includes(a.id) ? 'text-emerald-700 dark:text-emerald-400' : 'text-foreground'}">
                                        ${a.title}</div>
                                    <div class="text-xs text-muted-foreground">${a.desc}</div>
                                </div>
                                <div class="w-6 h-6 rounded-full border flex items-center justify-center transition-colors ${!student.missing.includes(a.id)
                    ? 'bg-emerald-500 border-emerald-500 text-white'
                    : 'border-input group-hover:border-primary'}">
                                    ${!student.missing.includes(a.id) ? '<i data-lucide="check" class="w-4 h-4"></i>' : ''}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
                <div class="p-6 border-t border-border bg-muted/30">
                    <button onclick="markAllComplete(${student.id}); closeStudentModal()"
                        class="inline-flex items-center justify-center rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 bg-primary text-primary-foreground hover:bg-primary/90 h-10 px-4 py-2 w-full">${t.markAll}</button>
                </div>
            `;

            modal.classList.remove('hidden');
            modal.classList.add('flex');
            setTimeout(() => {
                backdrop.classList.remove('opacity-0');
                content.classList.remove('opacity-0', 'scale-95');
            }, 10);
            lucide.createIcons();
        }

        function closeStudentModal() {
            const modal = document.getElementById('studentDetailModal');
            const backdrop = document.getElementById('detailBackdrop');
            const content = document.getElementById('detailContent');
            backdrop.classList.add('opacity-0');
            content.classList.add('opacity-0', 'scale-95');
            setTimeout(() => {
                modal.classList.add('hidden');
                modal.classList.remove('flex');
            }, 250);
        }

        function openManageModal() {
            const modal = document.getElementById('manageModal');
            const backdrop = document.getElementById('manageBackdrop');
            const content = document.getElementById('manageContent');
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            setTimeout(() => {
                backdrop.classList.remove('opacity-0');
                content.classList.remove('opacity-0', 'scale-95');
            }, 10);
            renderManageSubjects();
        }

        function closeManageModal() {
            const modal = document.getElementById('manageModal');
            const backdrop = document.getElementById('manageBackdrop');
            const content = document.getElementById('manageContent');
            backdrop.classList.add('opacity-0');
            content.classList.add('opacity-0', 'scale-95');
            setTimeout(() => {
                modal.classList.add('hidden');
                modal.classList.remove('flex');
            }, 250);
        }

        function renderManageSubjects() {
            const list = document.getElementById('manageSubjectsList');
            const t = translations[currentLang];
            list.innerHTML = appData.subjects.map(sub => `
                <div class="bg-card p-4 rounded-xl border border-border shadow-sm group">
                    <div class="flex justify-between items-center mb-3">
                        <div class="font-bold text-foreground">${sub.name}</div>
                        <div class="flex gap-2">
                            <button onclick="editSubject('${sub.id}')"
                                class="inline-flex items-center justify-center rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 border border-input bg-background hover:bg-accent hover:text-accent-foreground h-8 w-8"><i data-lucide="pencil" class="w-4 h-4"></i></button>
                            ${appData.subjects.length > 1 ? `<button onclick="deleteSubject('${sub.id}')"
                                class="inline-flex items-center justify-center rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 border border-input bg-background hover:bg-destructive hover:text-destructive-foreground h-8 w-8"><i data-lucide="trash-2" class="w-4 h-4"></i></button>` : ''}
                        </div>
                    </div>
                    <div class="space-y-2 pl-4 border-l-2 border-muted">
                        <div class="text-xs font-bold text-muted-foreground uppercase tracking-wider mb-2">${t.assignments}</div>
                        ${sub.assignments.map(a => `
                            <div class="flex justify-between items-center text-sm group/assign">
                                <span class="text-muted-foreground">${a.title}: ${a.desc}</span>
                                <button onclick="deleteAssignment('${sub.id}', '${a.id}')"
                                    class="text-muted-foreground hover:text-destructive opacity-0 group-hover/assign:opacity-100 transition-opacity"><i data-lucide="x" class="w-3 h-3"></i></button>
                            </div>
                        `).join('')}
                        <form onsubmit="handleAddAssignment(event, '${sub.id}')"
                            class="flex gap-2 mt-2 pt-2 border-t border-dashed border-border">
                            <input type="text" name="title" placeholder="${t.addAssignmentPlaceholder}"
                                class="flex h-9 w-1/3 rounded-md border border-input bg-background px-3 py-1 text-sm shadow-sm transition-colors file:border-0 file:bg-transparent file:text-sm file:font-medium placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:cursor-not-allowed disabled:opacity-50"
                                required>
                            <input type="text" name="desc" placeholder="${t.descPlaceholder}"
                                class="flex h-9 flex-1 rounded-md border border-input bg-background px-3 py-1 text-sm shadow-sm transition-colors file:border-0 file:bg-transparent file:text-sm file:font-medium placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:cursor-not-allowed disabled:opacity-50"
                                required>
                            <button type="submit"
                                class="inline-flex items-center justify-center rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 bg-secondary text-secondary-foreground hover:bg-secondary/80 h-9 px-3"><i data-lucide="plus" class="w-3 h-3"></i></button>
                        </form>
                    </div>
                </div>
            `).join('');
            lucide.createIcons();
        }

        function handleAddSubject(e) {
            e.preventDefault();
            const input = document.getElementById('newSubjectInput');
            const name = input.value.trim();
            if (!name) return;
            const newId = 'sub_' + Date.now();
            appData.subjects.push({ id: newId, name, assignments: [] });
            if (!appData.currentSubjectId) appData.currentSubjectId = newId;
            saveData();
            renderManageSubjects();
            renderTabs();
            input.value = '';
            const t = translations[currentLang];
            showToast(t.subjectAdded);
        }

        function deleteSubject(id) {
            const t = translations[currentLang];
            showConfirmModal(t.deleteSubjectTitle, t.deleteSubjectMsg, () => {
                appData.subjects = appData.subjects.filter(s => s.id !== id);
                if (appData.currentSubjectId === id && appData.subjects.length) {
                    appData.currentSubjectId = appData.subjects[0].id;
                }
                saveData();
                renderManageSubjects();
                renderApp();
                showToast(t.subjectDeleted, 'error');
            });
        }

        function editSubject(id) {
            const t = translations[currentLang];
            const subject = appData.subjects.find(s => s.id === id);
            if (!subject) return;
            const newName = prompt(t.editSubjectTitle, subject.name);
            if (newName && newName.trim() !== '') {
                subject.name = newName.trim();
                saveData();
                renderApp();
                renderManageSubjects();
                showToast(t.subjectUpdated);
            }
        }

        function handleAddAssignment(e, subId) {
            e.preventDefault();
            const t = translations[currentLang];
            const title = e.target.title.value.trim();
            const desc = e.target.desc.value.trim();
            const subject = appData.subjects.find(s => s.id === subId);
            if (subject && title && desc) {
                const newId = 'w' + Date.now();
                subject.assignments.push({ id: newId, title, desc });
                appData.students.forEach(s => s.missing.push(newId));
                saveData();
                renderManageSubjects();
                renderApp();
                e.target.reset();
                showToast(t.assignmentAdded);
            }
        }

        function deleteAssignment(subId, assignId) {
            const t = translations[currentLang];
            const subject = appData.subjects.find(s => s.id === subId);
            if (!subject) return;
            showConfirmModal(t.deleteAssignmentTitle, t.deleteAssignmentMsg, () => {
                subject.assignments = subject.assignments.filter(a => a.id !== assignId);
                appData.students.forEach(s => s.missing = s.missing.filter(m => m !== assignId));
                saveData();
                renderManageSubjects();
                renderApp();
                showToast(t.assignmentDeleted, 'error');
            });
        }

        function showToast(msg, type = 'success') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.innerHTML = `<div class="p-2 rounded-full ${type === 'success' ? 'bg-emerald-500/10 text-emerald-600 dark:text-emerald-400' : 'bg-destructive/10 text-destructive'}"><i data-lucide="${type === 'success' ? 'check' : 'alert-circle'}" class="w-5 h-5"></i></div>
                <div class="font-bold text-sm text-foreground">${msg}</div>`;
            container.appendChild(toast);
            lucide.createIcons();
            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transform = 'translateX(100%)';
                setTimeout(() => toast.remove(), 300);
            }, 2500);
        }

        let confirmCallback = null;
        function showConfirmModal(title, msg, callback) {
            document.getElementById('confirmTitle').innerText = title;
            document.getElementById('confirmMessage').innerText = msg;
            confirmCallback = callback;
            const modal = document.getElementById('confirmModal');
            const backdrop = document.getElementById('confirmBackdrop');
            const content = document.getElementById('confirmContent');
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            setTimeout(() => {
                backdrop.classList.remove('opacity-0');
                content.classList.remove('opacity-0', 'scale-95');
            }, 10);
        }

        document.getElementById('confirmCancelBtn').addEventListener('click', () => {
            const modal = document.getElementById('confirmModal');
            const backdrop = document.getElementById('confirmBackdrop');
            const content = document.getElementById('confirmContent');
            backdrop.classList.add('opacity-0');
            content.classList.add('opacity-0', 'scale-95');
            setTimeout(() => {
                modal.classList.add('hidden');
                modal.classList.remove('flex');
            }, 200);
        });

        document.getElementById('confirmOkBtn').addEventListener('click', () => {
            if (confirmCallback) confirmCallback();
            document.getElementById('confirmCancelBtn').click();
        });

        renderApp();
    </script>
</body>

</html>